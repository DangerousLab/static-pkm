# COMPLETE FILE - Ready to run
# .github/workflows/deploy.yml

name: Build and Deploy to GitHub Pages

on:
  push:
    branches: [main]
    paths:
      # Trigger on source file changes only
      - 'javascript/**/*.js'
      - 'css/**/*.css'
      - 'Home/**/*'
      - 'scripts/**/*.mjs'
      - 'rollup.config*.js'
      - 'package.json'
      - 'package-lock.json'
      - 'cache-scan.config.json'
      - 'index.html'
      - 'manifest.json'
      - 'service-worker.js'
      - 'vendor/**'
      - 'assets/**'
      
      # Exclude build artifacts - these should never trigger a build
      - '!javascript/app.min.js'
      - '!javascript/app.min.js.map'
      - '!javascript/tree.json'
      - '!javascript/cache-manifest.json'
      - '!css/app.min.css'
      - '!css/app.min.css.map'
      - '!css/main.css'
  
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write  # Required for peaceiris/actions-gh-pages
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build production files
        run: npm run build
      
      - name: Verify build artifacts
        run: |
          echo "üîç Verifying build output..."
          
          if [ ! -f "javascript/app.min.js" ]; then
            echo "‚ùå ERROR: javascript/app.min.js not found"
            exit 1
          fi
          
          if [ ! -f "css/app.min.css" ]; then
            echo "‚ùå ERROR: css/app.min.css not found"
            exit 1
          fi
          
          if [ ! -f "javascript/cache-manifest.json" ]; then
            echo "‚ùå ERROR: javascript/cache-manifest.json not found"
            exit 1
          fi
          
          if [ ! -f "javascript/tree.json" ]; then
            echo "‚ùå ERROR: javascript/tree.json not found"
            exit 1
          fi
          
          echo "‚úÖ All build artifacts verified"
          echo ""
          echo "üì¶ Build artifact sizes:"
          ls -lh javascript/app.min.js css/app.min.css javascript/cache-manifest.json javascript/tree.json
      
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: .
          publish_branch: gh-pages
          force_orphan: true
          user_name: 'github-actions[bot]'
          user_email: '41898282+github-actions[bot]@users.noreply.github.com'
          commit_message: 'chore: deploy production build'
          exclude_assets: |
            .github
            node_modules
            scripts
            rollup.config*.js
            postcss.config.cjs
            package.json
            package-lock.json
            *.md
            backup-*
            .cert
            .gitignore
            .vscode
            .idea
            .DS_Store
            setup-rollup.sh
            cache-scan.config.json
