{"version":3,"file":"app.min.js","sources":["core/state.js","core/utils.js","loader/platform-resources.js","loader/fontawesome-loader.js","modules/theme.js","modules/sidebar.js","loader/mathjax-loader.js","loader/index.js","core/message-tunnel.js","core/instance-manager.js","modules/content-loader.js","core/dom-isolation.js","core/js-isolation.js","modules/navigation.js","modules/preloader.js","modules/search.js","modules/safe-area-detector.js","modules/pwa.js","app.js","modules/keyboard-shortcuts.js"],"sourcesContent":["/**\n * Central state management for the application\n * All shared state variables and constants\n */\n\nexport const state = {\n  activeInstance: null,\n  activeNode: null,\n  baseSidebarWidth: 240,\n  hoverSidebarWidth: 240,\n  contentMaxWidth: 980,\n  hoverNeeded: false,\n  searchIndex: [],\n  selectedResultIndex: -1,\n  moduleDisplayNames: {},\n  preloadedModules: new Set(),\n  navigationTree: null,\n  currentFolder: null,\n  loadedScripts: new Set(),\n  moduleFactories: new Map(),\n  moduleReadyCallbacks: new Map(),\n  // Cache computed widths per folder path\n  folderWidthCache: new Map(),\n  // In-memory cache of fetched module code\n  moduleCodeCache: new Map(), // scriptUrl -> code string\n  // Track in-progress preload operations\n  preloadPromises: new Map(), // scriptUrl -> Promise<code>\n};\n\n\n\nexport const themeController = {\n  getTheme() {\n    return document.documentElement.getAttribute(\"data-theme\") || \"dark\";\n  },\n  subscribe(fn) {\n    document.addEventListener(\"themechange\", fn);\n    return () => document.removeEventListener(\"themechange\", fn);\n  },\n};\n\n// Export DOM references (initialized after DOM is ready)\nexport const dom = {\n  htmlEl: document.documentElement,\n  sidebar: null,\n  sidebarToggle: null,\n  sidebarNav: null,\n  sidebarBreadcrumb: null,\n  card: null,\n  themeToggleBtn: null,\n  themeIcon: null,\n  searchInput: null,\n  searchClear: null,\n  searchResults: null,\n  mainContent: null,\n};\n\n// Initialize DOM references when DOM is ready\nexport function initDOMRefs() {\n  dom.sidebar = document.getElementById(\"sidebar\");\n  dom.sidebarToggle = document.getElementById(\"sidebarToggle\");\n  dom.sidebarNav = document.getElementById(\"sidebarNav\");\n  dom.sidebarBreadcrumb = document.getElementById(\"sidebarBreadcrumb\");\n  dom.card = document.getElementById(\"contentCard\");\n  dom.themeToggleBtn = document.getElementById(\"themeToggle\");\n  dom.themeIcon = document.getElementById(\"themeIcon\");\n  dom.searchInput = document.getElementById(\"searchInput\");\n  dom.searchClear = document.getElementById(\"searchClear\");\n  dom.searchResults = document.getElementById(\"searchResults\");\n  dom.mainContent = document.querySelector(\".main-content\");\n}","/**\n * Utility functions\n * Helper functions used across multiple modules\n */\n\nimport { state } from './state.js';\n\n/**\n * Find a node by its path in the navigation tree\n */\nexport function findNodeByPath(node, path) {\n  if (node.path === path) return node;\n  if (!node.children) return null;\n  for (const child of node.children) {\n    const found = findNodeByPath(child, path);\n    if (found) return found;\n  }\n  return null;\n}\n\n/**\n * Find a leaf node (module/page/document) by its ID\n */\nexport function findLeafById(node, id) {\n  if (!node) return null;\n  if (\n    (node.type === \"module\" ||\n      node.type === \"page\" ||\n      node.type === \"document\") &&\n    node.id === id\n  ) {\n    return node;\n  }\n  if (!node.children) return null;\n  for (const child of node.children) {\n    const found = findLeafById(child, id);\n    if (found) return found;\n  }\n  return null;\n}\n\n/**\n * Find the parent folder of a given node\n */\nexport function findParentFolder(node) {\n  if (!node || !node.path) return state.navigationTree;\n\n  const pathParts = node.path.split(\"/\");\n  if (pathParts.length <= 1) return state.navigationTree;\n\n  const parentPath = pathParts.slice(0, -1).join(\"/\");\n  return findNodeByPath(state.navigationTree, parentPath) || state.navigationTree;\n}\n\n/**\n * Check if viewport is desktop or tablet size\n */\nexport function isDesktopOrTablet() {\n  return window.innerWidth >= 841;\n}\n\n/**\n * Check if viewport is medium size (tablet range)\n */\nexport function isMediumViewport() {\n  return window.innerWidth >= 841 && window.innerWidth <= 1470;\n}\n\n/**\n * Calculate if sidebar should auto-close on content click\n * Returns true if sidebar overlaps content when open\n * Computed dynamically based on viewport width and layout\n */\nexport function shouldAutoCloseSidebar() {\n  // Always auto-close in landscape mode\n  if (window.matchMedia('(max-height: 600px) and (orientation: landscape)').matches) {\n    return true;\n  }\n  \n  // Always auto-close on mobile (below tablet breakpoint)\n  if (window.innerWidth < 841) {\n    return true;\n  }\n  \n  // Desktop/tablet: Calculate if sidebar overlaps centered content\n  const sidebarWidth = state.baseSidebarWidth; // 240px by default\n  const contentMaxWidth = state.contentMaxWidth; // from .page-root max-width in CSS\n  const padding = 16; // Single side padding (var(--space-md))\n  \n  // Formula: content + (2 × sidebar) + (2 × padding)\n  // Content stays centered, needs equal space on both sides\n  const minWidthNoOverlap = contentMaxWidth + (2 * sidebarWidth) + (2 * padding);\n  \n  // If viewport is narrower than needed space, sidebar overlaps\n  return window.innerWidth < minWidthNoOverlap;\n}\n\n/**\n * Convert file path to URL\n */\nexport function scriptUrlFromFile(filePath) {\n  return \"./\" + filePath;\n}\n\n/**\n * Generate factory function name from module ID\n */\nexport function factoryNameFromId(id) {\n  return \"create\" + id.charAt(0).toUpperCase() + id.slice(1);\n}\n\n/**\n * Wait for a module factory to be registered\n */\nexport function waitForFactory(factoryName) {\n  return new Promise((resolve) => {\n    // Check if already available\n    if (typeof window[factoryName] === \"function\") {\n      resolve(window[factoryName]);\n      return;\n    }\n\n    // Register callback to be notified when ready\n    if (!state.moduleReadyCallbacks.has(factoryName)) {\n      state.moduleReadyCallbacks.set(factoryName, []);\n    }\n    state.moduleReadyCallbacks.get(factoryName).push(resolve);\n  });\n}\n\n/**\n * Notify that a module factory is ready\n */\nexport function notifyModuleReady(factoryName) {\n  const callbacks = state.moduleReadyCallbacks.get(factoryName);\n  if (callbacks) {\n    const factory = window[factoryName];\n    callbacks.forEach(cb => cb(factory));\n    state.moduleReadyCallbacks.delete(factoryName);\n  }\n}\n\n/**\n * Extract display name from module code without executing it\n * Looks for window.moduleInfo.displayName = \"...\" pattern\n * @param {string} code - Module source code\n * @returns {string|null} - Display name or null\n */\nexport function extractDisplayNameFromCode(code) {\n  if (!code || typeof code !== 'string') {\n    return null;\n  }\n  \n  // Match: window.moduleInfo = { displayName: \"Name\" }\n  const infoMatch = code.match(/window\\.moduleInfo\\s*=\\s*\\{[^}]*displayName\\s*:\\s*[\"']([^\"']+)[\"']/);\n  if (infoMatch) {\n    return infoMatch[1];\n  }\n  \n  // Fallback: Extract from function name (createMyModule → My Module)\n  const factoryMatch = code.match(/function\\s+(create\\w+)/);\n  if (factoryMatch) {\n    return factoryMatch[1]\n      .replace(/^create/, '')\n      .replace(/([A-Z])/g, ' $1')\n      .trim();\n  }\n  \n  return null;\n}\n","// javascript/loader/platform-resources.js\n\n/**\n * Platform Resources Registry\n * \n * Tracks loaded platform-level resources (MathJax, FontAwesome, etc.)\n * for debugging and future extensibility.\n * \n * v3.0: Resources load globally into document.head (no shadow DOM injection needed)\n * \n * @module PlatformResources\n */\n\n// Track registered platform resources (CSS, fonts, etc.)\nconst platformResources = new Map();\n\n/**\n * Register a platform resource (CSS file, font, etc.)\n * Called by loaders when they load external resources\n * \n * @param {Object} config - Resource configuration\n * @param {string} config.id - Unique resource ID (e.g., 'mathjax-fonts')\n * @param {string} config.type - Resource type ('css' | 'font' | 'style')\n * @param {string} config.url - CDN URL (for css/font)\n * @param {string} config.content - CSS content (for inline style)\n * @param {string} config.integrity - SRI hash (optional)\n * @param {string} config.name - Human-readable name (for logging)\n */\nexport function registerPlatformResource(config) {\n  const { id, type, url, content, integrity, name } = config;\n  \n  if (!id || !type) {\n    console.error('[PlatformResources] Invalid resource config:', config);\n    return;\n  }\n  \n  // Check if already registered\n  if (platformResources.has(id)) {\n    console.log(`[PlatformResources] Resource '${id}' already registered`);\n    return;\n  }\n  \n  const resource = {\n    id,\n    type,\n    url,\n    content,\n    integrity,\n    name: name || id,\n    loaded: false\n  };\n  \n  platformResources.set(id, resource);\n  console.log(`[PlatformResources] Registered platform resource: ${resource.name} (${type})`);\n}\n\n/**\n * Mark a platform resource as loaded\n * Called by loaders after resource loads successfully\n * \n * v3.0: No injection needed - resources load globally via document.head\n * \n * @param {string} resourceId - Resource ID to mark as loaded\n */\nexport function markResourceLoaded(resourceId) {\n  const resource = platformResources.get(resourceId);\n  \n  if (!resource) {\n    console.error(`[PlatformResources] Unknown resource ID: ${resourceId}`);\n    return;\n  }\n  \n  resource.loaded = true;\n  console.log(`[PlatformResources] Resource loaded globally: ${resource.name}`);\n}\n\n/**\n * Get list of loaded platform resources (for debugging)\n * \n * @returns {Array<Object>} Array of loaded resources\n */\nexport function getLoadedResources() {\n  return Array.from(platformResources.values()).filter(r => r.loaded);\n}\n","/**\n * Dynamic resource loader utility\n * Loads external CSS/JS resources on-demand with auto-detection\n */\n\nimport { registerPlatformResource, markResourceLoaded } from './platform-resources.js';\n\nconst loadedResources = new Set();\nlet fontAwesomeLoadPromise = null;\n\n/**\n * Load CSS resource dynamically\n */\nasync function loadCSS(url, integrity = null, crossorigin = 'anonymous') {\n  console.log('[DynamicLoader] Attempting to load CSS:', url);\n  \n  if (loadedResources.has(url)) {\n    console.log('[DynamicLoader] CSS already loaded, skipping:', url);\n    return Promise.resolve();\n  }\n\n  return new Promise((resolve, reject) => {\n    const link = document.createElement('link');\n    link.rel = 'stylesheet';\n    link.href = url;\n    \n    if (integrity) {\n      link.integrity = integrity;\n      link.crossOrigin = crossorigin;\n    }\n    \n    link.onload = () => {\n      loadedResources.add(url);\n      console.log('[DynamicLoader] CSS loaded successfully:', url);\n      resolve();\n    };\n    \n    link.onerror = () => {\n      console.error('[DynamicLoader] Failed to load CSS:', url);\n      reject(new Error(`Failed to load CSS: ${url}`));\n    };\n    \n    document.head.appendChild(link);\n  });\n}\n\n/**\n * Load FontAwesome icons (singleton pattern)\n * Returns same promise for concurrent calls\n */\nexport async function loadFontAwesome() {\n  // Return existing promise if already loading\n  if (fontAwesomeLoadPromise) {\n    console.log('[DynamicLoader] FontAwesome already loading, returning existing promise');\n    return fontAwesomeLoadPromise;\n  }\n\n  // Return immediately if already loaded\n  if (loadedResources.has('fontawesome')) {\n    console.log('[DynamicLoader] FontAwesome already loaded');\n    return Promise.resolve();\n  }\n\n  console.log('[DynamicLoader] Loading FontAwesome...');\n  \n  const faURL = 'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css';\n  \n  // Register FontAwesome as platform resource\n  registerPlatformResource({\n    id: 'fontawesome-css',\n    type: 'css',\n    url: faURL,\n    name: 'FontAwesome Icons'\n  });\n  \n  fontAwesomeLoadPromise = loadCSS(faURL)\n  .then(() => {\n    loadedResources.add('fontawesome');\n    \n    // Mark as loaded (available globally)\n    markResourceLoaded('fontawesome-css');\n    \n    console.log('[DynamicLoader] FontAwesome loaded globally');\n    fontAwesomeLoadPromise = null;\n  })\n  .catch((error) => {\n    console.error('[DynamicLoader] FontAwesome load failed:', error);\n    fontAwesomeLoadPromise = null;\n    throw error;\n  });\n\n  return fontAwesomeLoadPromise;\n}\n\n/**\n * Check if HTML string contains FontAwesome classes\n */\nexport function containsFontAwesomeIcons(htmlString) {\n  if (!htmlString) return false;\n  \n  const faPatterns = [\n    /class=[\"'][^\"']*\\bfa-/,\n    /class=[\"'][^\"']*\\bfas\\b/,\n    /class=[\"'][^\"']*\\bfar\\b/,\n    /class=[\"'][^\"']*\\bfab\\b/\n  ];\n  \n  return faPatterns.some(pattern => pattern.test(htmlString));\n}\n\n/**\n * Check if DOM element contains FontAwesome icons\n */\nexport function elementContainsFontAwesome(element) {\n  if (!element) return false;\n  \n  const classes = element.className;\n  if (typeof classes === 'string' && /\\bfa-|\\bfas\\b|\\bfar\\b|\\bfab\\b/.test(classes)) {\n    return true;\n  }\n  \n  const icons = element.querySelectorAll('[class*=\"fa-\"], .fas, .far, .fab');\n  return icons.length > 0;\n}\n\n/**\n * Load FontAwesome if content needs it (auto-detection)\n */\nexport async function loadIconsIfNeeded(content) {\n  let needsIcons = false;\n  \n  if (typeof content === 'string') {\n    needsIcons = containsFontAwesomeIcons(content);\n  } else if (content instanceof HTMLElement) {\n    needsIcons = elementContainsFontAwesome(content);\n  }\n  \n  if (needsIcons) {\n    console.log('[DynamicLoader] Content contains FontAwesome icons, loading...');\n    await loadFontAwesome();\n  } else {\n    console.log('[DynamicLoader] No FontAwesome icons detected in content');\n  }\n}\n\n/**\n * Get icon HTML for common types\n * Returns FontAwesome HTML without loading the library\n * Caller is responsible for ensuring icons are loaded\n */\nexport function getTypeIcon(type) {\n  switch (type) {\n    case \"module\":\n      return '<i class=\"fa-solid fa-gear\"></i>';\n    case \"page\":\n      return '<i class=\"fa-regular fa-file\"></i>';\n    case \"document\":\n      return '<i class=\"fa-regular fa-file-lines\"></i>';\n    case \"folder\":\n      return '<i class=\"fa-regular fa-folder\"></i>';\n    case \"back\":\n      return '<i class=\"fa-solid fa-caret-left\"></i>';\n    default:\n      return '<i class=\"fa-solid fa-circle\"></i>';\n  }\n}\n\n/**\n * Get custom icon HTML\n * @param {string} iconClass - FontAwesome class (e.g., 'fa-solid fa-heart')\n */\nexport function getIcon(iconClass) {\n  return `<i class=\"${iconClass}\"></i>`;\n}\n\n/**\n * Render content with auto-loaded icons\n * Detects if content needs icons and loads them automatically\n * @param {string|HTMLElement} content - Content to render\n * @param {HTMLElement} container - Container to render into\n */\nexport async function renderWithIcons(content, container) {\n  await loadIconsIfNeeded(content);\n  \n  if (typeof content === 'string') {\n    container.innerHTML = content;\n  } else if (content instanceof HTMLElement) {\n    container.appendChild(content);\n  }\n}\n","/**\n * Theme management module\n * Handles dark/light theme toggling and asset switching with preloading\n * PRODUCTION FIX v2: Addresses hover-triggered HTTP requests\n */\n\nimport { dom, state, themeController } from '../core/state.js';\nimport { loadFontAwesome } from '../loader/fontawesome-loader.js';\n\n// Cache for preloaded images\nconst imageCache = {\n  'logo-dark': null,\n  'logo-light': null,\n  'banner-dark': null,\n  'banner-light': null\n};\n\n// Track if animation is in progress to debounce\nlet animationInProgress = false;\n\n/**\n * Preload all theme images (logos and banners only)\n * Returns a Promise that resolves when all images are loaded\n */\nfunction preloadThemeImages() {\n  const images = [\n    { key: 'logo-dark', src: './assets/logo-dark.png' },\n    { key: 'logo-light', src: './assets/logo-light.png' },\n    { key: 'banner-dark', src: './assets/banner-dark.png' },\n    { key: 'banner-light', src: './assets/banner-light.png' }\n  ];\n\n  // Create promises for each image load\n  const loadPromises = images.map(({ key, src }) => {\n    return new Promise((resolve, reject) => {\n      const img = new Image();\n      img.onload = () => {\n        imageCache[key] = img;\n        console.log(`[Theme] Preloaded ${key}`);\n        resolve();\n      };\n      img.onerror = () => {\n        console.warn(`[Theme] Failed to preload ${key}`);\n        imageCache[key] = img; // Store anyway, fallback to string path\n        resolve(); // Don't block on error\n      };\n      img.src = src;\n    });\n  });\n\n  return Promise.all(loadPromises).then(() => {\n    console.log('[Theme] All theme assets preloaded and ready');\n  });\n}\n\n/**\n * Set theme color in meta tag\n */\nexport function setThemeMetaColor(theme) {\n  const themeColorMeta = document.getElementById('theme-color-meta');\n\n  if (themeColorMeta) {\n    themeColorMeta.setAttribute(\"content\", theme === \"dark\" ? \"#1f1f1f\" : \"#f3f4f6\");\n  }\n}\n\n/**\n * Replace image element with cached version (NO HTTP request)\n * ENHANCED: Additional safeguards for production stability\n * @param {HTMLImageElement} targetImg - The img element to replace\n * @param {string} cacheKey - Key in imageCache\n * @param {string} fallbackSrc - Fallback URL if cache fails\n */\nfunction replaceWithCachedImage(targetImg, cacheKey, fallbackSrc) {\n  const cachedImg = imageCache[cacheKey];\n\n  if (cachedImg && cachedImg.complete && cachedImg.naturalWidth > 0) {\n    // Check if src is already correct (avoid unnecessary DOM operations)\n    if (targetImg.src === cachedImg.src) {\n      console.log(`[Theme] ${targetImg.id} already using correct cached image, skipping replace`);\n      return targetImg;\n    }\n\n    // Clone the cached image to get a fresh DOM element\n    const newImg = cachedImg.cloneNode(false);\n\n    // Copy all attributes from target (except src which is already correct)\n    Array.from(targetImg.attributes).forEach(attr => {\n      if (attr.name !== 'src') {\n        newImg.setAttribute(attr.name, attr.value);\n      }\n    });\n\n    // Copy computed classes\n    newImg.className = targetImg.className;\n\n    // PRODUCTION FIX: Block all interactions to prevent hover prefetching\n    newImg.style.pointerEvents = 'none';\n    newImg.style.userSelect = 'none';\n\n    // Replace in DOM (this uses the cached bitmap, NO HTTP request)\n    targetImg.parentNode.replaceChild(newImg, targetImg);\n\n    console.log(`[Theme] Replaced ${targetImg.id} with cached image (0 HTTP requests)`);\n    return newImg;\n  } else {\n    // Fallback: set src directly (will trigger HTTP request)\n    console.warn(`[Theme] Cache miss for ${cacheKey}, using fallback (HTTP request)`);\n    targetImg.src = fallbackSrc;\n    return targetImg;\n  }\n}\n\n/**\n * Clean up animation state after completion\n * Removes will-change to free GPU resources\n */\nfunction cleanupAnimation(element) {\n  if (!element) return;\n\n  // Remove will-change after animation completes\n  element.addEventListener('animationend', function handler() {\n    element.style.willChange = 'auto';\n    element.removeEventListener('animationend', handler);\n  }, { once: true });\n}\n\n/**\n * Update logo and banner based on theme with slide-up animation\n */\nexport function updateThemeAssets(theme) {\n  // Debounce: prevent rapid successive calls during hover\n  if (animationInProgress) {\n    console.log('[Theme] Animation in progress, skipping update');\n    return;\n  }\n\n  animationInProgress = true;\n\n  let headerLogo = document.getElementById('headerLogo');\n  let headerBanner = document.getElementById('headerBanner');\n  const headerTagline = document.querySelector('.header-tagline');\n  let landscapeLogo = document.getElementById('landscapeLogo');\n\n  if (headerLogo && headerBanner) {\n    // Step 1: Remove existing animations by removing class\n    headerLogo.classList.remove('animate');\n    headerBanner.classList.remove('animate');\n    if (headerTagline) {\n      headerTagline.classList.remove('animate');\n    }\n\n    // Step 2: Force reflow to ensure animation can restart\n    void headerLogo.offsetWidth;\n    void headerBanner.offsetWidth;\n    if (headerTagline) {\n      void headerTagline.offsetWidth;\n    }\n\n    // Step 3: Temporarily disable animation on elements\n    headerLogo.style.animation = 'none';\n    headerBanner.style.animation = 'none';\n    if (headerTagline) {\n      headerTagline.style.animation = 'none';\n    }\n\n    // Step 4: Replace with cached images (ZERO HTTP requests)\n    const logoKey = theme === 'dark' ? 'logo-dark' : 'logo-light';\n    const bannerKey = theme === 'dark' ? 'banner-dark' : 'banner-light';\n    const logoFallback = theme === 'dark' ? './assets/logo-dark.png' : './assets/logo-light.png';\n    const bannerFallback = theme === 'dark' ? './assets/banner-dark.png' : './assets/banner-light.png';\n\n    // Replace elements (updates references since new elements are created)\n    headerLogo = replaceWithCachedImage(headerLogo, logoKey, logoFallback);\n    headerBanner = replaceWithCachedImage(headerBanner, bannerKey, bannerFallback);\n\n    // Step 5: Re-enable animation and add animate class in next frame\n    requestAnimationFrame(() => {\n      // Remove inline style to restore CSS animation\n      headerLogo.style.animation = '';\n      headerBanner.style.animation = '';\n      if (headerTagline) {\n        headerTagline.style.animation = '';\n      }\n\n      // Add animate class to trigger animation\n      requestAnimationFrame(() => {\n        headerLogo.classList.add('animate');\n        headerBanner.classList.add('animate');\n        if (headerTagline) {\n          headerTagline.classList.add('animate');\n        }\n\n        // Clean up GPU resources after animation\n        cleanupAnimation(headerLogo);\n        cleanupAnimation(headerBanner);\n        if (headerTagline) {\n          cleanupAnimation(headerTagline);\n        }\n\n        // Reset debounce flag after animation starts\n        setTimeout(() => {\n          animationInProgress = false;\n        }, 50);\n      });\n    });\n  }\n\n  // Update landscape left bar logo WITH animation\n  if (landscapeLogo) {\n    // Step 1: Remove existing animation\n    landscapeLogo.classList.remove('animate');\n\n    // Step 2: Force reflow\n    void landscapeLogo.offsetWidth;\n\n    // Step 3: Temporarily disable animation\n    landscapeLogo.style.animation = 'none';\n\n    // Step 4: Replace with cached image (ZERO HTTP requests)\n    const logoKey = theme === 'dark' ? 'logo-dark' : 'logo-light';\n    const logoFallback = theme === 'dark' ? './assets/logo-dark.png' : './assets/logo-light.png';\n\n    landscapeLogo = replaceWithCachedImage(landscapeLogo, logoKey, logoFallback);\n\n    // Step 5: Re-enable animation\n    requestAnimationFrame(() => {\n      landscapeLogo.style.animation = '';\n      requestAnimationFrame(() => {\n        landscapeLogo.classList.add('animate');\n        cleanupAnimation(landscapeLogo);\n      });\n    });\n  }\n}\n\n/**\n * Toggle between dark and light themes\n */\nexport function toggleTheme() {\n  const current = dom.htmlEl.getAttribute(\"data-theme\") || \"dark\";\n  const next = current === \"dark\" ? \"light\" : \"dark\";\n  dom.htmlEl.setAttribute(\"data-theme\", next);\n\n  // Update main theme icon (FontAwesome)\n  dom.themeIcon.innerHTML = next === \"dark\" \n    ? '<i class=\"fa-regular fa-moon\"></i>' \n    : '<i class=\"fa-regular fa-sun\"></i>';\n\n  // Update landscape theme icon (FontAwesome)\n  const landscapeThemeIcon = document.getElementById('landscapeThemeIcon');\n  if (landscapeThemeIcon) {\n    landscapeThemeIcon.innerHTML = next === \"dark\" \n      ? '<i class=\"fa-regular fa-moon\"></i>' \n      : '<i class=\"fa-regular fa-sun\"></i>';\n  }\n\n  setThemeMetaColor(next);\n  updateThemeAssets(next);\n\n  const event = new CustomEvent(\"themechange\", { detail: { theme: next } });\n  document.dispatchEvent(event);\n\n  if (state.activeInstance && typeof state.activeInstance.onThemeChange === \"function\") {\n    requestAnimationFrame(() => {\n      if (state.activeInstance && typeof state.activeInstance.onThemeChange === \"function\") {\n        state.activeInstance.onThemeChange(next);\n      }\n    });\n  }\n}\n\n/**\n * Initialize theme system\n * Returns a Promise that resolves when theme is fully initialized\n */\nexport async function initTheme() {\n  // Preload all theme images and wait for completion\n  await preloadThemeImages();\n  \n  // Preload FontAwesome for theme icons\n  await loadFontAwesome();\n\n  // Main theme toggle\n  dom.themeToggleBtn.addEventListener(\"click\", toggleTheme);\n\n  // Landscape left bar theme toggle\n  const landscapeThemeToggle = document.getElementById('landscapeThemeToggle');\n  if (landscapeThemeToggle) {\n    landscapeThemeToggle.addEventListener(\"click\", toggleTheme);\n  }\n\n  const initialTheme = dom.htmlEl.getAttribute(\"data-theme\") || \"dark\";\n  \n  // Set initial theme icon (FontAwesome)\n  dom.themeIcon.innerHTML = initialTheme === \"dark\" \n    ? '<i class=\"fa-regular fa-moon\"></i>' \n    : '<i class=\"fa-regular fa-sun\"></i>';\n\n  // Set initial landscape theme icon (FontAwesome)\n  const landscapeThemeIcon = document.getElementById('landscapeThemeIcon');\n  if (landscapeThemeIcon) {\n    landscapeThemeIcon.innerHTML = initialTheme === \"dark\" \n      ? '<i class=\"fa-regular fa-moon\"></i>' \n      : '<i class=\"fa-regular fa-sun\"></i>';\n  }\n\n  setThemeMetaColor(initialTheme);\n}\n","/**\n * Sidebar management module\n * Handles sidebar width application and hover behavior\n * Width computation is now done during preload (cached)\n */\n\nimport { dom, state } from '../core/state.js';\nimport { isDesktopOrTablet } from '../core/utils.js';\nimport { loadFontAwesome } from '../loader/fontawesome-loader.js';\n\n// Track hover state explicitly\nlet isCurrentlyHovering = false;\n\n// Track if sidebar content has been initialized\nlet sidebarContentInitialized = false;\n\n/**\n * Check if in landscape mode\n */\nfunction isLandscapeMode() {\n  return window.matchMedia('(max-height: 600px) and (orientation: landscape)').matches;\n}\n\n/**\n * Apply sidebar width based on current hover state\n * Uses pre-computed cached values from preloader\n */\nexport function applySidebarWidth() {\n  // Skip width application in landscape mode (CSS handles it)\n  if (isLandscapeMode()) return;\n  \n  if (!isDesktopOrTablet()) return;\n  if (dom.sidebar.getAttribute(\"data-open\") !== \"true\") return;\n\n  // Use tracked hover state and cached values\n  if (isCurrentlyHovering && state.hoverNeeded) {\n    dom.sidebar.style.width = state.hoverSidebarWidth + \"px\";\n    console.log('[Sidebar] Applied cached hover width:', state.hoverSidebarWidth);\n  } else {\n    dom.sidebar.style.width = state.baseSidebarWidth + \"px\";\n    console.log('[Sidebar] Applied base width:', state.baseSidebarWidth);\n  }\n}\n\n/**\n * Toggle sidebar open/closed state\n */\nexport async function toggleSidebar() { \n  const isOpen = dom.sidebar.getAttribute(\"data-open\") === \"true\";\n  const next = !isOpen;\n  \n  // Initialize sidebar content on first open\n  if (next && !sidebarContentInitialized) { \n    console.log('[Sidebar] First open - initializing content with icons');\n    await initSidebarSearch();  // Load FontAwesome + inject search HTML\n    sidebarContentInitialized = true;\n  }\n\n  // In landscape mode, use simpler toggle (CSS handles positioning)\n  if (isLandscapeMode()) {\n    dom.sidebar.setAttribute(\"data-open\", String(next));\n    dom.sidebarToggle.setAttribute(\"data-open\", String(next));\n    \n    const landscapeToggle = document.getElementById('landscapeToggle');\n    if (landscapeToggle) {\n      landscapeToggle.setAttribute(\"data-open\", String(next));\n    }\n    return;\n  }\n\n  if (isDesktopOrTablet()) {\n    if (next) {\n      dom.sidebar.setAttribute(\"data-open\", \"true\");\n      dom.sidebarToggle.setAttribute(\"data-open\", \"true\");\n      \n      // Sync landscape toggle if exists\n      const landscapeToggle = document.getElementById('landscapeToggle');\n      if (landscapeToggle) {\n        landscapeToggle.setAttribute(\"data-open\", \"true\");\n      }\n      \n      dom.sidebar.style.width = state.baseSidebarWidth + \"px\";\n    } else {\n      const currentWidth = dom.sidebar.getBoundingClientRect().width;\n      dom.sidebar.style.width = currentWidth + \"px\";\n      dom.sidebar.setAttribute(\"data-open\", \"false\");\n      dom.sidebarToggle.setAttribute(\"data-open\", \"false\");\n      \n      // Sync landscape toggle if exists\n      const landscapeToggle = document.getElementById('landscapeToggle');\n      if (landscapeToggle) {\n        landscapeToggle.setAttribute(\"data-open\", \"false\");\n      }\n\n      // Reset hover state when closing\n      isCurrentlyHovering = false;\n\n      dom.sidebar.addEventListener('transitionend', function handler(e) {\n        if (e.propertyName === 'transform' && dom.sidebar.getAttribute(\"data-open\") !== \"true\") {\n          dom.sidebar.style.width = \"\";\n        }\n        dom.sidebar.removeEventListener('transitionend', handler);\n      });\n    }\n  } else {\n    dom.sidebar.setAttribute(\"data-open\", String(next));\n    dom.sidebarToggle.setAttribute(\"data-open\", String(next));\n    \n    // Sync landscape toggle if exists\n    const landscapeToggle = document.getElementById('landscapeToggle');\n    if (landscapeToggle) {\n      landscapeToggle.setAttribute(\"data-open\", String(next));\n    }\n  }\n}\n\n/**\n * Clear active state from all sidebar items\n */\nexport function clearSidebarActive() {\n  const items = dom.sidebarNav.querySelectorAll(\".nav-item\");\n  items.forEach((b) => b.classList.remove(\"active\"));\n}\n\n/**\n * Handle sidebar mouse enter event\n */\nfunction handleSidebarMouseEnter() {\n  // Skip hover behavior in landscape mode\n  if (isLandscapeMode()) return;\n  \n  if (!isDesktopOrTablet()) return;\n  if (dom.sidebar.getAttribute(\"data-open\") !== \"true\") return;\n\n  isCurrentlyHovering = true;\n  console.log('[Sidebar] Mouse enter - using cached hoverNeeded:', state.hoverNeeded);\n\n  if (!state.hoverNeeded) {\n    dom.sidebar.style.width = state.baseSidebarWidth + \"px\";\n    return;\n  }\n  dom.sidebar.style.width = state.hoverSidebarWidth + \"px\";\n}\n\n/**\n * Handle sidebar mouse leave event\n */\nfunction handleSidebarMouseLeave(e) {\n  // Skip hover behavior in landscape mode\n  if (isLandscapeMode()) return;\n  \n  if (!isDesktopOrTablet()) return;\n  if (dom.sidebar.getAttribute(\"data-open\") !== \"true\") return;\n\n  const related = e.relatedTarget;\n  if (related && dom.sidebar.contains(related)) {\n    return;\n  }\n\n  isCurrentlyHovering = false;\n  console.log('[Sidebar] Mouse leave - resetting to base width');\n  dom.sidebar.style.width = state.baseSidebarWidth + \"px\";\n}\n\n/**\n * Initialize sidebar search UI\n * Injects search HTML and loads icons\n */\nasync function initSidebarSearch() {  // ← ADDED: New function\n  const searchContainer = document.querySelector('.sidebar-search');\n  if (!searchContainer) {\n    console.warn('[Sidebar] .sidebar-search container not found');\n    return;\n  }\n  \n  console.log('[Sidebar] Initializing search UI with icons');\n  \n  // Load FontAwesome first\n  await loadFontAwesome();\n  \n  // Inject search HTML\n  searchContainer.innerHTML = `\n    <div class=\"search-input-wrapper\">\n      <span class=\"search-icon\">\n        <i class=\"fa-solid fa-magnifying-glass\"></i>\n      </span>\n      <input\n        type=\"text\"\n        id=\"searchInput\"\n        class=\"search-input\"\n        placeholder=\"Search (Ctrl+K)\"\n        aria-label=\"Search any pages\"\n        autocomplete=\"off\"\n      />\n      <button\n        id=\"searchClear\"\n        class=\"search-clear\"\n        type=\"button\"\n        aria-label=\"Clear search\"\n        style=\"display: none;\"\n      >\n        <i class=\"fa-solid fa-xmark\"></i>\n      </button>\n    </div>\n    <div id=\"searchResults\" class=\"search-results\" style=\"display: none;\"></div>\n  `;\n  \n  // Update DOM refs for search elements (they didn't exist at initial page load)\n  dom.searchInput = document.getElementById('searchInput');\n  dom.searchClear = document.getElementById('searchClear');\n  dom.searchResults = document.getElementById('searchResults');\n  \n  console.log('[Sidebar] Search UI initialized with updated DOM refs');\n  \n  // Initialize search event listeners now that HTML exists\n  const { initSearch } = await import('./search.js'); \n  initSearch();\n  console.log('[Sidebar] Search event listeners attached');\n}\n\n\n/**\n * Initialize sidebar event listeners\n */\nexport function initSidebar() { \n  // Main sidebar toggle\n  if (!dom.sidebarToggle) {\n    console.error('[Sidebar] sidebarToggle element not found - cannot initialize');\n    return;\n  }\n  \n  dom.sidebarToggle.addEventListener(\"click\", toggleSidebar);\n  \n  // Landscape left bar sidebar toggle\n  const landscapeToggle = document.getElementById('landscapeToggle');\n  if (landscapeToggle) {\n    landscapeToggle.addEventListener(\"click\", toggleSidebar);\n  }\n  \n  // Hover behavior\n  dom.sidebar.addEventListener(\"mouseenter\", handleSidebarMouseEnter);\n  dom.sidebar.addEventListener(\"mouseleave\", handleSidebarMouseLeave);\n}\n\n/**\n * Check if sidebar content has been initialized\n */\nexport function isSidebarContentInitialized() {  // ← ADDED: Export state checker\n  return sidebarContentInitialized;\n}","/**\n * MathJax Loader\n * Loads MathJax globally for rendering math expressions\n * Resources load once into document.head and work across all modules\n */\n\nimport { registerPlatformResource, markResourceLoaded } from './platform-resources.js';\n\nlet mathJaxLoaded = false;\nlet mathJaxLoadingPromise = null;\n\n/**\n * Load MathJax globally (lazy-loaded on first use)\n * Safe to call multiple times - only loads once\n * @returns {Promise<void>}\n */\nexport async function loadMathJax() {\n  if (mathJaxLoaded) {\n    return Promise.resolve();\n  }\n\n  if (mathJaxLoadingPromise) {\n    return mathJaxLoadingPromise;\n  }\n\n  console.log('[MathJax Loader] Loading MathJax from CDN...');\n  \n  // Register MathJax output styles as platform resource\n  registerPlatformResource({\n    id: 'mathjax-output-css',\n    type: 'style',\n    name: 'MathJax Output CSS',\n    content: `\n      /* MathJax CHTML Output Styling (Font-Based) */\n      mjx-container {\n        display: inline-block;\n        margin: 0;\n        padding: 0;\n      }\n      \n      mjx-container[display=\"true\"] {\n        display: block;\n        margin: 1em 0;\n        text-align: center;\n      }\n      \n      /* Inherit theme colors */\n      mjx-container {\n        color: inherit;\n      }\n      \n      /* Font rendering improvements */\n      mjx-container mjx-math {\n        display: inline-block;\n        line-height: 0;\n      }\n      \n      mjx-container mjx-math mjx-mtext {\n        line-height: normal;\n      }\n    `\n  });\n\n  mathJaxLoadingPromise = new Promise((resolve, reject) => {\n    // Configure MathJax BEFORE loading script\n    window.MathJax = {\n      tex: {\n        inlineMath: [[\"\\\\(\", \"\\\\)\"], [\"$\", \"$\"]],\n        displayMath: [[\"\\\\[\", \"\\\\]\"], [\"$$\", \"$$\"]]\n      },\n      chtml: {\n        fontURL: 'https://cdn.jsdelivr.net/npm/mathjax@3/es5/output/chtml/fonts/woff-v2'\n      },\n      options: {\n        skipHtmlTags: [\"script\", \"noscript\", \"style\", \"textarea\", \"pre\"]\n      },\n      startup: {\n        ready: () => {\n          window.MathJax.startup.defaultReady();\n          mathJaxLoaded = true;\n          \n          // Mark CSS resource as loaded\n          markResourceLoaded('mathjax-output-css');\n          \n          console.log('[MathJax Loader] MathJax loaded globally');\n          resolve();\n        }\n      }\n    };\n\n    // Load MathJax from CDN (use CHTML output with web fonts)\n    const script = document.createElement('script');\n    script.src = 'https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js';\n    script.async = true;\n    script.onerror = () => {\n      console.error('[MathJax Loader] Failed to load MathJax from CDN');\n      mathJaxLoadingPromise = null;\n      reject(new Error('Failed to load MathJax'));\n    };\n    document.head.appendChild(script);\n  });\n\n  return mathJaxLoadingPromise;\n}\n\n/**\n * Check if MathJax is already loaded\n * @returns {boolean}\n */\nexport function isMathJaxLoaded() {\n  return mathJaxLoaded;\n}\n\n/**\n * Typeset math equations in any container\n * MathJax uses web fonts for crisp, scalable rendering\n * @param {HTMLElement} container - Container with LaTeX equations\n * @returns {Promise<void>}\n */\nexport async function typesetMath(container) {\n  if (!container) {\n    console.warn('[MathJax Loader] typesetMath called with null container');\n    return;\n  }\n\n  await loadMathJax();\n\n  if (window.MathJax?.typesetPromise) {\n    try {\n      console.log('[MathJax Loader] Typesetting math in container...');\n      await window.MathJax.typesetPromise([container]);\n      console.log('[MathJax Loader] Typesetting complete');\n    } catch (error) {\n      console.error('[MathJax Loader] Typesetting failed:', error);\n    }\n  }\n}","/**\n * Central Loader Registry\n * Provides unified access to all lazy-loaded libraries\n */\n\nimport { \n  loadFontAwesome,\n  elementContainsFontAwesome\n} from './fontawesome-loader.js';\nimport { \n  loadMathJax, \n  typesetMath \n} from './mathjax-loader.js';\n\n// Re-export MathJax loader\nexport { loadMathJax, typesetMath } from './mathjax-loader.js';\n\n// Re-export FontAwesome loader + helpers\nexport { \n  loadFontAwesome,\n  containsFontAwesomeIcons,\n  elementContainsFontAwesome,\n  loadIconsIfNeeded,\n  getTypeIcon, \n  getIcon,\n  renderWithIcons\n} from './fontawesome-loader.js';\n\n// Future loaders can be added here:\n// export { loadChartJS } from './chartjs-loader.js';\n// export { loadPrism } from './prism-loader.js';\n\n/**\n * Auto-render all passive content (icons, math, etc.)\n * Scans container and loads only what's needed\n * @param {HTMLElement} container - Container to scan and render\n * @returns {Promise<void>}\n */\nexport async function autoRender(container) {\n  if (!container) return;\n  \n  console.log('[Loader] Auto-rendering passive content...');\n  \n  const loadPromises = [];\n  \n  // Check for FontAwesome icons\n  if (elementContainsFontAwesome(container)) {\n    console.log('[Loader] Detected FontAwesome icons');\n    loadPromises.push(loadFontAwesome());\n  }\n  \n  // Check for MathJax (look for \\( \\) or \\[ \\] patterns)\n  const html = container.innerHTML;\n  if (/\\\\\\(|\\\\\\[|\\$\\$?/.test(html)) {\n    console.log('[Loader] Detected math expressions');\n    loadPromises.push(loadMathJax().then(() => typesetMath(container)));\n  }\n  \n  // Load all detected libraries in parallel\n  if (loadPromises.length > 0) {\n    await Promise.all(loadPromises);\n    console.log('[Loader] Auto-render complete');\n  } else {\n    console.log('[Loader] No passive content detected');\n  }\n}\n\n/**\n * Re-render passive content after dynamic DOM updates\n * Handles all platform resources that need re-processing\n * @param {HTMLElement} container - Container with updated content\n * @returns {Promise<void>}\n */\nexport async function dynamicRender(container) {\n  if (!container) return;\n  \n  console.log('[Loader] Dynamic re-render...');\n  \n  const rerenderPromises = [];\n  \n  // Re-typeset math if MathJax is loaded\n  if (window.MathJax?.typesetPromise) {\n    const html = container.innerHTML;\n    // Check for LaTeX delimiters: \\( \\) \\[ \\] $ $$\n    if (/\\\\\\(|\\\\\\[|\\$\\$?/.test(html)) {\n      rerenderPromises.push(typesetMath(container));\n    }\n  }\n  \n  // Icons don't need re-rendering (CSS-based)\n  // Future: Add other library re-renders here (Prism syntax highlighting, etc.)\n  \n  if (rerenderPromises.length > 0) {\n    await Promise.all(rerenderPromises);\n    console.log('[Loader] Dynamic re-render complete');\n  }\n}\n","/**\n * Message Tunnel for Inter-Module Communication\n * Safe, controlled communication between isolated modules\n */\n\nclass MessageTunnel {\n  constructor() {\n    this.subscribers = new Map(); // instanceId -> Set of callbacks\n    this.messageLog = []; // For debugging\n  }\n  \n  /**\n   * Send message to specific instance\n   */\n  send(fromInstanceId, toInstanceId, message) {\n    console.log(`[Tunnel] ${fromInstanceId} → ${toInstanceId}:`, message);\n    \n    // Log message\n    this.messageLog.push({\n      timestamp: Date.now(),\n      from: fromInstanceId,\n      to: toInstanceId,\n      message: message\n    });\n    \n    // Deliver to subscribers\n    const callbacks = this.subscribers.get(toInstanceId);\n    if (callbacks && callbacks.size > 0) {\n      const envelope = {\n        from: fromInstanceId,\n        to: toInstanceId,\n        message: message,\n        timestamp: Date.now()\n      };\n      \n      callbacks.forEach(callback => {\n        try {\n          callback(envelope);\n        } catch (error) {\n          console.error(`[Tunnel] Error in message handler for ${toInstanceId}:`, error);\n        }\n      });\n    } else {\n      console.warn(`[Tunnel] No subscribers for ${toInstanceId}`);\n    }\n  }\n  \n  /**\n   * Broadcast message to all instances\n   */\n  broadcast(fromInstanceId, message) {\n    console.log(`[Tunnel] Broadcast from ${fromInstanceId}:`, message);\n    \n    this.subscribers.forEach((callbacks, toInstanceId) => {\n      if (toInstanceId !== fromInstanceId) {\n        this.send(fromInstanceId, toInstanceId, message);\n      }\n    });\n  }\n  \n  /**\n   * Subscribe to messages for an instance\n   */\n  subscribe(instanceId, callback) {\n    if (!this.subscribers.has(instanceId)) {\n      this.subscribers.set(instanceId, new Set());\n    }\n    \n    this.subscribers.get(instanceId).add(callback);\n    console.log(`[Tunnel] Subscribed: ${instanceId}`);\n  }\n  \n  /**\n   * Unsubscribe all callbacks for an instance\n   */\n  unsubscribe(instanceId) {\n    this.subscribers.delete(instanceId);\n    console.log(`[Tunnel] Unsubscribed: ${instanceId}`);\n  }\n  \n  /**\n   * Create tunnel API for a specific instance\n   */\n  createInstanceAPI(instanceId) {\n    return {\n      send: (toInstanceId, message) => {\n        this.send(instanceId, toInstanceId, message);\n      },\n      \n      broadcast: (message) => {\n        this.broadcast(instanceId, message);\n      },\n      \n      onMessage: (callback) => {\n        this.subscribe(instanceId, callback);\n      }\n    };\n  }\n  \n  /**\n   * Get message log for debugging\n   */\n  getMessageLog() {\n    return [...this.messageLog];\n  }\n  \n  /**\n   * Clear message log\n   */\n  clearMessageLog() {\n    this.messageLog = [];\n  }\n}\n\n// Singleton instance\nexport const messageTunnel = new MessageTunnel();\n","/**\n * Instance Manager (Phase 0: Single Instance)\n * \n * Future-proof: Designed to be extended for multi-instance (Phase 1)\n * and transclusion (Phase 2) without breaking changes.\n */\n\nimport { messageTunnel } from './message-tunnel.js';\n\nclass InstanceManager {\n  constructor() {\n    this.instances = new Map();\n    this.compartments = new Map(); // Track SES compartments\n    this.metadata = new Map();\n    this.hierarchy = new Map();\n  }\n  \n  /**\n   * Register a new instance\n   */\n  register(instanceId, instance, metadata = {}) {\n    this.instances.set(instanceId, instance);\n    this.metadata.set(instanceId, {\n      moduleId: metadata.moduleId || null,\n      parentId: metadata.parentId || null,\n      cardId: metadata.cardId || 'card1',\n      rootElement: metadata.rootElement || null,\n      container: metadata.container || null,\n      createdAt: Date.now()\n    });\n    \n    if (metadata.parentId) {\n      if (!this.hierarchy.has(metadata.parentId)) {\n        this.hierarchy.set(metadata.parentId, []);\n      }\n      this.hierarchy.get(metadata.parentId).push(instanceId);\n    }\n    \n    console.log('[InstanceManager] Registered:', instanceId);\n  }\n  \n  /**\n   * Get an instance by ID\n   */\n  get(instanceId) {\n    return this.instances.get(instanceId) || null;\n  }\n  \n  /**\n   * Destroy instance and all its children\n   */\n  destroy(instanceId) {\n    const instanceData = this.instances.get(instanceId);\n    \n    if (!instanceData) {\n      console.warn(`[InstanceManager] Instance not found: ${instanceId}`);\n      return;\n    }\n\n    // Get all descendants\n    const descendants = this._getDescendants(instanceId);\n    \n    // Destroy in reverse order (children before parents)\n    const allToDestroy = [...descendants, instanceId].reverse();\n    \n    allToDestroy.forEach(id => {\n      const data = this.instances.get(id);\n      if (data && data.instance && typeof data.instance.destroy === 'function') {\n        try {\n          data.instance.destroy();\n          console.log(`[InstanceManager] Destroyed instance: ${id}`);\n        } catch (error) {\n          console.error(`[InstanceManager] Error destroying ${id}:`, error);\n        }\n      }\n      \n      // Cleanup compartment\n      this.destroyCompartment(id);\n      \n      // Cleanup message tunnel subscriptions\n      messageTunnel.unsubscribe(id);\n      \n      this.instances.delete(id);\n    });\n    \n    console.log(`[InstanceManager] Destroyed: ${instanceId}`);\n  }\n  \n  /**\n   * Get all descendant instance IDs (recursive)\n   */\n  _getDescendants(instanceId) {\n    const descendants = [];\n    const children = this.hierarchy.get(instanceId) || [];\n    \n    children.forEach(childId => {\n      descendants.push(childId);\n      descendants.push(...this._getDescendants(childId));\n    });\n    \n    return descendants;\n  }\n  \n    /**\n   * Generate unique instance ID\n   * Phase 0: card1:moduleId\n   * Phase 1+: card2:moduleId, card1:parent/child\n   */\n  generateInstanceId(moduleId, parentInstanceId = null, cardId = 'card1') {\n    if (!parentInstanceId) {\n      return `${cardId}:${moduleId}`;\n    }\n    \n    const basePath = `${parentInstanceId}/${moduleId}`;\n    let index = 0;\n    let candidateId = basePath;\n    \n    while (this.instances.has(candidateId)) {\n      candidateId = `${basePath}#${index}`;\n      index++;\n    }\n    \n    return candidateId;\n  }\n\n  /**\n   * Register SES compartment for an instance\n   */\n  registerCompartment(instanceId, compartment) {\n    this.compartments.set(instanceId, compartment);\n    console.log(`[InstanceManager] Registered compartment for: ${instanceId}`);\n  }\n\n  /**\n   * Get compartment for an instance\n   */\n  getCompartment(instanceId) {\n    return this.compartments.get(instanceId);\n  }\n\n  /**\n   * Destroy compartment (called during instance cleanup)\n   */\n  destroyCompartment(instanceId) {\n    const compartment = this.compartments.get(instanceId);\n    if (compartment) {\n      // SES compartments don't have explicit destroy, just remove reference\n      this.compartments.delete(instanceId);\n      console.log(`[InstanceManager] Destroyed compartment: ${instanceId}`);\n    }\n  }\n\n  /**\n   * Route message between instances\n   */\n  routeMessage(fromInstanceId, toInstanceId, message) {\n    messageTunnel.send(fromInstanceId, toInstanceId, message);\n  }\n\n  /**\n   * Get instance by ID (for message delivery)\n   */\n  getInstanceById(instanceId) {\n    return this.instances.get(instanceId);\n  }\n\n  /**\n   * Clear all instances\n   */\n  clear() {\n    this.instances.forEach((data, id) => {\n      if (data.instance && typeof data.instance.destroy === 'function') {\n        try {\n          data.instance.destroy();\n        } catch (error) {\n          console.error(`[InstanceManager] Error destroying ${id}:`, error);\n        }\n      }\n      \n      // Cleanup compartment\n      this.destroyCompartment(id);\n      \n      // Cleanup message tunnel\n      messageTunnel.unsubscribe(id);\n    });\n    \n    this.instances.clear();\n    this.compartments.clear();\n    console.log('[InstanceManager] All instances and compartments cleared');\n  }\n}\n\nexport const instanceManager = new InstanceManager();\n","/**\n * Content loading module\n * Handles loading of modules, pages, and documents\n */\n\nimport { dom, state, themeController } from '../core/state.js';\nimport { scriptUrlFromFile, factoryNameFromId, waitForFactory } from '../core/utils.js';\nimport { autoRender, dynamicRender } from '../loader/index.js';\nimport { instanceManager } from '../core/instance-manager.js';\nimport { createSandboxedDocument, createSandboxedWindow } from '../core/dom-isolation.js';\nimport { createSecureCompartment, buildCompartmentGlobals } from '../core/js-isolation.js';\nimport { messageTunnel } from '../core/message-tunnel.js';\n\n/**\n * Detect module layer (Platform vs User)\n * @param {string} filePath - Module file path from tree.json\n * @returns {'PLATFORM'|'USER'}\n */\nfunction getModuleLayer(filePath) {\n  // Normalize path (remove leading ./ if present)\n  const normalized = filePath.replace(/^\\.\\//, '');\n  \n  // User Layer: Home/ directory (user modules)\n  if (normalized.startsWith('Home/')) {\n    return 'USER';\n  }\n  \n  // User Layer: javascript/user/ (user utilities)\n  if (normalized.startsWith('javascript/user/')) {\n    return 'USER';\n  }\n  \n  // Platform Layer: Everything else\n  // Note: Platform modules (javascript/modules/*) are statically imported in app.js\n  // They should NEVER appear in tree.json or be loaded via content-loader\n  return 'PLATFORM';\n}\n\n/**\n * Clear active module instance\n */\nexport function clearActiveInstance() {\n  if (state.activeInstance && typeof state.activeInstance.destroy === \"function\") {\n    try {\n      const instanceId = state.activeNode \n        ? instanceManager.generateInstanceId(state.activeNode.id, null, 'card1')\n        : null;\n      \n      if (instanceId) {\n        instanceManager.destroy(instanceId);\n      } else {\n        state.activeInstance.destroy();\n      }\n    } catch (e) {\n      console.error('[ContentLoader] Failed to destroy instance:', e);\n    }\n  }\n  state.activeInstance = null;\n}\n\n/**\n * Fetch module code as text (for compartment evaluation)\n * Coordinates with preloader using Promises to avoid redundant fetches\n */\nexport async function fetchModuleCode(src) {\n  // Check if code is already cached by preloader\n  if (state.moduleCodeCache.has(src)) {\n    const cachedCode = state.moduleCodeCache.get(src);\n    console.log('[ContentLoader] Using cached code from preloader:', src, '(', cachedCode.length, 'bytes )');\n    return cachedCode;\n  }\n  \n  // Check if preloader is currently fetching this module\n  if (state.preloadPromises.has(src)) {\n    console.log('[ContentLoader] Waiting for preloader to finish fetching:', src);\n    try {\n      const code = await state.preloadPromises.get(src);\n      console.log('[ContentLoader] Received code from preloader:', src, '(', code.length, 'bytes )');\n      return code;\n    } catch (error) {\n      console.warn('[ContentLoader] Preloader failed, fetching directly:', error.message);\n      // Fall through to fetch ourselves\n    }\n  }\n  \n  // Not cached and not being preloaded, fetch from network\n  console.log('[ContentLoader] Fetching module as text:', src);\n  \n  const response = await fetch(src);\n  if (!response.ok) {\n    throw new Error(`Failed to fetch module: ${response.status} ${response.statusText}`);\n  }\n  \n  const code = await response.text();\n  console.log('[ContentLoader] Fetched', code.length, 'bytes');\n  \n  // Cache for future use\n  state.moduleCodeCache.set(src, code);\n  \n  return code;\n}\n\n/**\n * Get factory function for a module by evaluating in compartment\n * Returns { factory, moduleCode } to avoid re-fetching\n */\nexport async function getFactoryForModule(node, compartment) {\n  const scriptSrc = scriptUrlFromFile(node.file);\n  const factoryName = factoryNameFromId(node.id);\n\n  // Fetch module code as text (service worker caches this in PWA!)\n  const moduleCode = await fetchModuleCode(scriptSrc);\n  \n  // Evaluate code inside compartment (compiled with sandboxed globals)\n  try {\n    compartment.evaluate(moduleCode);\n    console.log('[ContentLoader] Evaluated module code in compartment');\n  } catch (error) {\n    console.error('[ContentLoader] Failed to evaluate module code:', error);\n    throw new Error(`Module evaluation failed for ${node.id}: ${error.message}`);\n  }\n  \n  // Get factory from compartment's window (modules register on window.createModuleName)\n  const factory = compartment.globalThis.window[factoryName];\n  \n  if (typeof factory !== \"function\") {\n    console.error('[ContentLoader] Factory lookup failed. Available on window:', Object.keys(compartment.globalThis.window || {}));\n    throw new Error(\n      `Factory ${factoryName} not found or not a function in compartment for module ${node.id}`\n    );\n  }\n  \n  console.log('[ContentLoader] Factory extracted from compartment:', factoryName);\n  \n  return { factory, moduleCode };\n}\n\n/**\n * Load a module (interactive tool/calculator)\n * Note: Shared CSS patterns loaded via modules.css in index.html\n * Module-specific styles are inlined in each module's JS file\n */\nexport async function loadModule(node, done) {\n  // Detect module layer for logging and future extensibility\n  const moduleLayer = getModuleLayer(node.file);\n  console.log('[ContentLoader] Loading module:', node.id, '| Layer:', moduleLayer, '| File:', node.file);\n  \n  // Validation: Only USER layer modules should be loaded via content-loader\n  if (moduleLayer === 'PLATFORM') {\n    console.error('[ContentLoader] ERROR: Platform modules should not be in navigation tree!');\n    console.error('[ContentLoader] Platform modules must be statically imported in app.js');\n    console.error('[ContentLoader] Attempted to load:', node.file);\n    dom.card.innerHTML = \"\\n\\nConfiguration Error: Platform module in navigation tree.\";\n    dom.card.classList.remove(\"preload\");\n    dom.card.classList.add(\"loaded\");\n    done(null);\n    return;\n  }\n  \n  // All modules loaded here are USER layer (apply isolation)\n  console.log('[ContentLoader] Applying USER LAYER isolation (SES + Scoped CSS)');\n  \n  // Create instance ID first\n  const instanceId = instanceManager.generateInstanceId(node.id, null, 'card1');\n  \n  // Create regular DOM container (no shadow root in v3.0)\n  const container = document.createElement(\"div\");\n  container.className = \"module-container\";\n  container.dataset.instanceId = instanceId;\n  dom.card.appendChild(container);\n  \n  // Create sandboxed APIs (scoped to container)\n  const sandboxedDocument = createSandboxedDocument(instanceId, container);\n  const sandboxedWindow = createSandboxedWindow(instanceId);\n  const tunnel = messageTunnel.createInstanceAPI(instanceId);\n  \n  // Create secure compartment with sandboxed globals (no factory/options yet!)\n  const compartmentGlobals = buildCompartmentGlobals(\n    instanceId,\n    sandboxedDocument,\n    sandboxedWindow,\n    tunnel,\n    themeController,\n    dynamicRender,\n  );\n  \n  const compartment = createSecureCompartment(instanceId, compartmentGlobals);\n  instanceManager.registerCompartment(instanceId, compartment);\n\n  // Fetch and evaluate module code in compartment\n  getFactoryForModule(node, compartment)\n    .then(({ factory }) => {\n      // Create options object\n      const options = {\n        container: container,\n        themeController: themeController,\n        dynamicRender: dynamicRender,\n        instanceId: instanceId,\n        parentInstanceId: null,\n        tunnel: tunnel\n      };\n\n      let instance = null;\n      try {\n        console.log('[ContentLoader] Creating module instance from compartment factory:', instanceId);\n        \n        // Add options to compartment globals\n        compartment.globalThis.__options = options;\n        \n        // Call factory INSIDE compartment (correct context for DOM methods!)\n        const factoryName = factoryNameFromId(node.id);\n        instance = compartment.evaluate(`window.${factoryName}(__options)`) || {};\n        \n      } catch (err) {\n        console.error('[ContentLoader] Module instantiation failed:', err);\n        dom.card.innerHTML = \"\\n\\nUnable to load module.\";\n        dom.card.classList.remove(\"preload\");\n        dom.card.classList.add(\"loaded\");\n        done(null);\n        return;\n      }\n\n      requestAnimationFrame(async () => { \n        // v3.0: CSS isolation via scoped class prefixes\n        // Modules use .modulename- prefix pattern\n        \n        await autoRender(container);\n        dom.card.classList.remove(\"preload\");\n        dom.card.classList.add(\"loaded\");\n        \n        console.log('[ContentLoader] Module loaded successfully in isolated environment:', instanceId);\n      });\n\n      instanceManager.register(instanceId, instance, {\n        moduleId: node.id,\n        parentId: null,\n        cardId: 'card1',\n        rootElement: container,\n        container: container\n      });\n\n      done(instance);\n    })\n    .catch((err) => {\n      console.error('[ContentLoader] Module loading failed:', err);\n      dom.card.innerHTML = \"\\n\\nUnable to load module.\";\n      dom.card.classList.remove(\"preload\");\n      dom.card.classList.add(\"loaded\");\n      done(null);\n    });\n}\n\n/**\n * Load a page (static HTML content)\n */\nexport function loadPage(node, done) {\n  const url = scriptUrlFromFile(node.file);\n  fetch(url)\n    .then((res) => {\n      if (!res.ok) throw new Error(\"Failed to load page: \" + url);\n      return res.text();\n    })\n    .then((html) => {\n      dom.card.innerHTML = html;\n      dom.card.classList.remove(\"preload\");\n      dom.card.classList.add(\"loaded\");\n      done({});\n    })\n    .catch((err) => {\n      console.error(err);\n      dom.card.innerHTML = \"\\n\\nUnable to load page.\";\n      dom.card.classList.remove(\"preload\");\n      dom.card.classList.add(\"loaded\");\n      done(null);\n    });\n}\n\n/**\n * Load a document (text/markdown content)\n */\nexport function loadDocument(node, done) {\n  const url = scriptUrlFromFile(node.file);\n  fetch(url)\n    .then((res) => {\n      if (!res.ok) throw new Error(\"Failed to load document: \" + url);\n      return res.text();\n    })\n    .then((md) => {\n      const inner = document.createElement(\"div\");\n      inner.className = \"document-root\";\n      const pre = document.createElement(\"pre\");\n      pre.textContent = md;\n      inner.appendChild(pre);\n      dom.card.appendChild(inner);\n      dom.card.classList.remove(\"preload\");\n      dom.card.classList.add(\"loaded\");\n      done({});\n    })\n    .catch((err) => {\n      console.error(err);\n      dom.card.innerHTML = \"\\n\\nUnable to load document.\";\n      dom.card.classList.remove(\"preload\");\n      dom.card.classList.add(\"loaded\");\n      done(null);\n    });\n}\n\n/**\n * Open a node (module/page/document)\n */\nexport function openNode(node) {\n  if (!node) return;\n\n  // Skip reload if this node is already active\n  if (state.activeNode && state.activeNode.id === node.id) {\n    console.log('[ContentLoader] Node', node.id, 'already active, skipping reload');\n    return;\n  }\n\n  clearActiveInstance();\n\n  dom.card.classList.remove(\"loaded\");\n  dom.card.classList.add(\"preload\");\n  dom.card.innerHTML = \"\";\n\n  const type = node.type;\n\n  if (type === \"module\") {\n    loadModule(node, (instance) => {\n      state.activeInstance = instance || {};\n      state.activeNode = node;\n    });\n  } else if (type === \"page\") {\n    loadPage(node, (instance) => {\n      state.activeInstance = instance || {};\n      state.activeNode = node;\n    });\n  } else if (type === \"document\") {\n    loadDocument(node, (instance) => {\n      state.activeInstance = instance || {};\n      state.activeNode = node;\n    });\n  } else {\n    dom.card.classList.remove(\"preload\");\n    dom.card.classList.add(\"loaded\");\n    state.activeInstance = {};\n    state.activeNode = node;\n  }\n}","/**\n * DOM Isolation Layer\n * Proxied document/window APIs for SES compartments\n */\n\nexport function createSandboxedDocument(instanceId, container) {\n  // DOM node limits (prevents DoS attacks)\n  const MAX_NODES = 10000;  // Maximum nodes per module\n  const WARN_THRESHOLD = 0.8;  // Warn at 80% capacity\n  let nodeCount = 0;\n  let warningSent = false;\n  \n  // Proxied document that restricts access to module container\n  return new Proxy({}, {\n    get(target, prop) {\n      // Allow safe methods scoped to module container\n      if (prop === 'querySelector') {\n        return container.querySelector.bind(container);\n      }\n      if (prop === 'querySelectorAll') {\n        return container.querySelectorAll.bind(container);\n      }\n      if (prop === 'createElement') {\n        // Return wrapped createElement with node counting\n        return function(tagName) {\n          // Check limit before creating\n          if (nodeCount >= MAX_NODES) {\n            const error = new Error(\n              `[DOMIsolation] DOM node limit exceeded for ${instanceId}. ` +\n              `Maximum ${MAX_NODES} nodes allowed. ` +\n              `This prevents browser DoS attacks.`\n            );\n            console.error(error.message);\n            throw error;\n          }\n          \n          // Increment counter\n          nodeCount++;\n          \n          // Warn at threshold\n          if (!warningSent && nodeCount >= MAX_NODES * WARN_THRESHOLD) {\n            warningSent = true;\n            console.warn(\n              `[DOMIsolation] ${instanceId} has created ${nodeCount} nodes ` +\n              `(${Math.round((nodeCount / MAX_NODES) * 100)}% of limit). ` +\n              `Consider optimizing DOM operations.`\n            );\n          }\n          \n          // Create element\n          return document.createElement.call(document, tagName);\n        };\n      }\n      if (prop === 'createTextNode') {\n        // Text nodes also count toward limit\n        return function(data) {\n          if (nodeCount >= MAX_NODES) {\n            const error = new Error(\n              `[DOMIsolation] DOM node limit exceeded for ${instanceId}`\n            );\n            console.error(error.message);\n            throw error;\n          }\n          \n          nodeCount++;\n          \n          if (!warningSent && nodeCount >= MAX_NODES * WARN_THRESHOLD) {\n            warningSent = true;\n            console.warn(\n              `[DOMIsolation] ${instanceId} approaching node limit: ${nodeCount}/${MAX_NODES}`\n            );\n          }\n          \n          return document.createTextNode.call(document, data);\n        };\n      }\n      if (prop === 'createDocumentFragment') {\n        // Fragments don't count (they're temporary containers)\n        return document.createDocumentFragment.bind(document);\n      }\n      if (prop === 'createComment') {\n        // Comments also count (though rarely abused)\n        return function(data) {\n          if (nodeCount >= MAX_NODES) {\n            const error = new Error(\n              `[DOMIsolation] DOM node limit exceeded for ${instanceId}`\n            );\n            console.error(error.message);\n            throw error;\n          }\n          \n          nodeCount++;\n          return document.createComment.call(document, data);\n        };\n      }\n      \n      // Expose node count for debugging (read-only)\n      if (prop === '__nodeCount') {\n        return nodeCount;\n      }\n      if (prop === '__nodeLimit') {\n        return MAX_NODES;\n      }\n      \n      // Block dangerous operations\n      if (prop === 'body' || prop === 'head' || prop === 'documentElement') {\n        console.warn(`[DOMIsolation] Blocked access to document.${prop} from ${instanceId}`);\n        return null;\n      }\n      \n      console.warn(`[DOMIsolation] Blocked document.${prop} from ${instanceId}`);\n      return undefined;\n    }\n  });\n}\n\nexport function createSandboxedWindow(instanceId) {\n  // Storage for module-specific properties (factory, moduleInfo, etc.)\n  const moduleStorage = {};\n  \n  // Track event listeners for cleanup (stored outside proxy to prevent module access)\n  const eventListeners = new Map();\n  \n  // Proxied window that restricts access\n  return new Proxy(moduleStorage, {\n    get(target, prop) {\n      // Allow safe globals (constructors and objects)\n      const safeGlobals = [\n        'Math', 'JSON', 'Array', 'Object', 'String', 'Number', 'Boolean', \n        'Date', 'RegExp', 'Map', 'Set', 'Promise', 'Error', 'TypeError',\n        'RangeError', 'SyntaxError', 'parseInt', 'parseFloat', 'isNaN',\n        'isFinite', 'decodeURI', 'decodeURIComponent', 'encodeURI',\n        'encodeURIComponent'\n      ];\n      \n      if (safeGlobals.includes(prop)) {\n        return window[prop];\n      }\n      \n      // Allow reading module-registered properties (factory functions, moduleInfo)\n      if (prop in target) {\n        return target[prop];\n      }\n      \n      // Block dangerous operations\n      if (prop === 'document' || prop === 'localStorage' || prop === 'sessionStorage') {\n        console.warn(`[DOMIsolation] Blocked access to window.${prop} from ${instanceId}`);\n        return undefined;\n      }\n      \n      // Allow event-related APIs (with restrictions)\n      if (prop === 'CustomEvent') {\n        // Return constructor, not bound function!\n        return window.CustomEvent;\n      }\n      \n      if (prop === 'Event') {\n        return window.Event;\n      }\n      \n      if (prop === 'addEventListener') {\n        // Return scoped addEventListener\n        return function(eventName, handler, options) {\n          // Define safe global events (browser/UI events only)\n          const safeGlobalEvents = ['resize', 'scroll', 'focus', 'blur'];\n          \n          // Check if event is instance-specific or safe global\n          const isInstanceEvent = eventName.startsWith(instanceId);\n          const isSafeGlobal = safeGlobalEvents.includes(eventName);\n          \n          if (!isInstanceEvent && !isSafeGlobal) {\n            console.warn(\n              `[DOMIsolation] Blocked addEventListener('${eventName}') from ${instanceId}. ` +\n              `Use tunnel API for module communication or prefix with '${instanceId}:'`\n            );\n            return;\n          }\n          \n          // Add listener to real window\n          window.addEventListener(eventName, handler, options);\n          \n          // Track for cleanup on module destroy\n          if (!eventListeners.has(eventName)) {\n            eventListeners.set(eventName, []);\n          }\n          eventListeners.get(eventName).push({ handler, options });\n          \n          console.log(`[DOMIsolation] Allowed addEventListener('${eventName}') from ${instanceId}`);\n        };\n      }\n      \n      if (prop === 'removeEventListener') {\n        // Return scoped removeEventListener\n        return function(eventName, handler, options) {\n          window.removeEventListener(eventName, handler, options);\n          \n          // Remove from tracking\n          if (eventListeners.has(eventName)) {\n            const listeners = eventListeners.get(eventName);\n            const index = listeners.findIndex(l => l.handler === handler);\n            if (index !== -1) {\n              listeners.splice(index, 1);\n            }\n          }\n          \n          console.log(`[DOMIsolation] removeEventListener('${eventName}') from ${instanceId}`);\n        };\n      }\n      \n      if (prop === 'dispatchEvent') {\n        // Return scoped dispatchEvent\n        return function(event) {\n          // Only allow dispatching instance-specific events\n          const isInstanceEvent = event.type.startsWith(instanceId);\n          \n          if (!isInstanceEvent) {\n            console.warn(\n              `[DOMIsolation] Blocked dispatchEvent('${event.type}') from ${instanceId}. ` +\n              `Event type must be prefixed with '${instanceId}:'`\n            );\n            return false;\n          }\n          \n          console.log(`[DOMIsolation] Allowed dispatchEvent('${event.type}') from ${instanceId}`);\n          return window.dispatchEvent(event);\n        };\n      }\n      \n      // Allow __moduleReady callback pattern (legacy modules)\n      if (prop === '__moduleReady' && typeof window.__moduleReady === 'function') {\n        return window.__moduleReady;\n      }\n      \n      console.warn(`[DOMIsolation] Blocked window.${prop} from ${instanceId}`);\n      return undefined;\n    },\n    \n    set(target, prop, value) {\n      // Allow setting factory functions (createModuleName pattern)\n      if (prop.startsWith('create') && typeof value === 'function') {\n        console.log(`[DOMIsolation] Allowed factory registration: window.${prop} from ${instanceId}`);\n        target[prop] = value;\n        return true;\n      }\n      \n      // Allow setting moduleInfo\n      if (prop === 'moduleInfo' && typeof value === 'object') {\n        console.log(`[DOMIsolation] Allowed moduleInfo registration from ${instanceId}`);\n        target[prop] = value;\n        return true;\n      }\n      \n      // Block everything else\n      console.warn(`[DOMIsolation] Blocked setting window.${prop} from ${instanceId}`);\n      return false;\n    }\n  });\n}\n","/**\n * JavaScript Isolation Layer\n * SES Compartment wrapper for secure module execution\n */\n\nexport function createSecureCompartment(instanceId, globalOverrides = {}) {\n  const compartment = new Compartment(globalOverrides);\n  \n  console.log(`[JSIsolation] Created secure compartment for ${instanceId}`);\n  \n  return compartment;\n}\n\nexport function evaluateModuleFactory(compartment, factoryName) {\n  // Module already loaded in global scope, get reference\n  try {\n    // Evaluate code that returns the factory from window\n    const factory = compartment.evaluate(`\n      (function() {\n        if (typeof window !== 'undefined' && typeof window.${factoryName} === 'function') {\n          return window.${factoryName};\n        }\n        throw new Error('Factory ${factoryName} not found');\n      })()\n    `);\n    \n    return factory;\n  } catch (error) {\n    console.error(`[JSIsolation] Failed to evaluate factory ${factoryName}:`, error);\n    throw error;\n  }\n}\n\nexport function buildCompartmentGlobals(instanceId, sandboxedDocument, sandboxedWindow, tunnel, themeController, dynamicRender) {\n  return {\n    // Sandboxed globals\n    document: sandboxedDocument,\n    window: sandboxedWindow,\n    \n    // Safe globals (hardened by lockdown())\n    console: console,\n    Math: Math,\n    JSON: JSON,\n    Array: Array,\n    Object: Object,\n    String: String,\n    Number: Number,\n    Boolean: Boolean,\n    Date: Date,\n    RegExp: RegExp,\n    Map: Map,\n    Set: Set,\n    Promise: Promise,\n    Error: Error,\n    TypeError: TypeError,\n    RangeError: RangeError,\n    SyntaxError: SyntaxError,\n    \n    // Event constructors (needed for modules that dispatch events)\n    CustomEvent: CustomEvent,\n    Event: Event,\n    \n    // Utility functions\n    parseInt: parseInt,\n    parseFloat: parseFloat,\n    isNaN: isNaN,\n    isFinite: isFinite,\n    \n    // Animation frame (for rendering, NOT logic timing - allowed by project rules)\n    requestAnimationFrame: requestAnimationFrame.bind(window),\n    cancelAnimationFrame: cancelAnimationFrame.bind(window),\n    \n    // Utilities provided by app (HARDENED to prevent prototype pollution)\n    tunnel: harden(tunnel),\n    themeController: harden(themeController),\n    dynamicRender: harden(dynamicRender),\n    \n    // Block dangerous globals\n    eval: undefined,\n    Function: undefined,\n    setTimeout: undefined,  // Enforce no setTimeout (your rule)\n    setInterval: undefined,  // Enforce no setInterval (your rule)\n    \n    // Block network access (prevents data exfiltration)\n    fetch: undefined,\n    XMLHttpRequest: undefined,\n    \n    // Block DOM observers (prevents parent DOM spying)\n    MutationObserver: undefined,\n    IntersectionObserver: undefined,\n    ResizeObserver: undefined\n  };\n}\n","/**\n * Navigation module\n * Handles breadcrumb and sidebar navigation rendering\n */\n\nimport { dom, state } from '../core/state.js';\nimport { findNodeByPath, findLeafById } from '../core/utils.js';\nimport { clearSidebarActive, applySidebarWidth, toggleSidebar } from './sidebar.js';\nimport { openNode } from './content-loader.js';\nimport { isDesktopOrTablet } from '../core/utils.js';\nimport { loadFontAwesome, getTypeIcon } from '../loader/fontawesome-loader.js'; \n\n// Track if icons have been loaded for navigation\nlet iconsLoaded = false;\n\n/**\n * Ensure FontAwesome is loaded before rendering navigation icons\n */\nasync function ensureIconsLoaded() {\n  if (iconsLoaded) return;\n  \n  console.log('[Navigation] Loading FontAwesome icons');\n  await loadFontAwesome();\n  iconsLoaded = true;\n}\n\n/**\n * Check if in landscape mode\n */\nfunction isLandscapeMode() {\n  return window.matchMedia('(max-height: 600px) and (orientation: landscape)').matches;\n}\n\n/**\n * Render breadcrumb navigation\n */\nexport function renderBreadcrumb() {\n  if (!state.navigationTree || !state.currentFolder) return;\n  if (!dom.sidebarBreadcrumb) return;\n\n  dom.sidebarBreadcrumb.innerHTML = \"\";\n\n  const fullPath = state.currentFolder.path || \"Home\";\n  const segments = fullPath.split(\"/\");\n\n  segments.forEach((segment, index) => {\n    const isLast = index === segments.length - 1;\n    const path = segments.slice(0, index + 1).join(\"/\");\n\n    const part = document.createElement(\"span\");\n    part.textContent = segment;\n    part.className = \"sidebar-breadcrumb-part\" + (isLast ? \" current\" : \"\");\n\n    if (!isLast) {\n      part.addEventListener(\"click\", () => {\n        if (path === state.currentFolder.path) return;\n        const node = findNodeByPath(state.navigationTree, path);\n        if (!node || node.type !== \"folder\") return;\n\n        navigateToFolder(node);\n      });\n    }\n\n    dom.sidebarBreadcrumb.appendChild(part);\n\n    if (!isLast) {\n      const sep = document.createElement(\"span\");\n      sep.textContent = \"/\";\n      sep.className = \"sidebar-breadcrumb-separator\";\n      dom.sidebarBreadcrumb.appendChild(sep);\n    }\n  });\n}\n\n/**\n * Navigate to a folder - unified function for all folder navigation\n * This triggers all necessary actions: render sidebar, preload, calculate width\n */\nexport async function navigateToFolder(folderNode) { \n  console.log('[Navigation] Navigating to folder:', folderNode.path || 'Home');\n  await renderSidebar(folderNode); \n  window.dispatchEvent(new CustomEvent('folderNavigated', {\n    detail: { folderNode }\n  }));\n}\n\nexport async function renderSidebar(folderNode) {\n  console.log('[Navigation] Rendering sidebar for folder:', folderNode.path || 'Home');\n  \n  // Only load icons if sidebar content is initialized (user has opened sidebar)\n  // This prevents loading FontAwesome on initial page load\n  if (typeof window !== 'undefined') { \n    const sidebarModule = await import('./sidebar.js');\n    if (sidebarModule.isSidebarContentInitialized && sidebarModule.isSidebarContentInitialized()) {\n      await ensureIconsLoaded();\n    }\n  }\n  \n  state.currentFolder = folderNode;\n  dom.sidebarNav.innerHTML = \"\";\n\n  renderBreadcrumb();\n\n  const items = [];\n\n  // Add \"Back\" button if not at root\n  if (folderNode !== state.navigationTree) {\n    const parentPath = folderNode.path.split(\"/\").slice(0, -1).join(\"/\");\n    const parentNode = findNodeByPath(state.navigationTree, parentPath);\n    if (parentNode) {\n      const upItem = document.createElement(\"button\");\n      upItem.type = \"button\";\n      upItem.className = \"nav-item\";\n      upItem.setAttribute(\"data-type\", \"folder\");\n      upItem.setAttribute(\"data-path\", parentNode.path);\n      upItem.innerHTML = `\n        <span class=\"nav-index\"></span>\n        <span class=\"nav-icon\">${getTypeIcon(\"back\")}</span>\n        <span class=\"nav-label\">Back</span>\n      `;\n      items.push(upItem);\n    }\n  }\n\n  // Add folder children\n  if (folderNode.children) {\n    folderNode.children.forEach((child, index) => {\n      const btn = document.createElement(\"button\");\n      btn.type = \"button\";\n      btn.className = \"nav-item\";\n\n      if (child.type === \"folder\") {\n        btn.setAttribute(\"data-type\", \"folder\");\n        btn.setAttribute(\"data-path\", child.path);\n        btn.innerHTML = `\n          <span class=\"nav-index\">${String(index + 1).padStart(2, \"0\")}</span>\n          <span class=\"nav-icon\">${getTypeIcon(\"folder\")}</span>\n          <span class=\"nav-label\">${child.name}</span>\n        `;\n      } else {\n        // module, page, document\n        btn.setAttribute(\"data-type\", child.type);\n        btn.setAttribute(\"data-id\", child.id);\n        const label =\n          state.moduleDisplayNames[child.id] ||\n          child.title ||\n          child.id ||\n          \"Loading\";\n        btn.innerHTML = `\n          <span class=\"nav-index\">${String(index + 1).padStart(2, \"0\")}</span>\n          <span class=\"nav-icon\">${getTypeIcon(child.type)}</span>\n          <span class=\"nav-label\">${label}</span>\n        `;\n\n        if (state.activeNode && state.activeNode.id === child.id) {\n          btn.classList.add(\"active\");\n        }\n      }\n\n      items.push(btn);\n    });\n  }\n\n  items.forEach((btn) => dom.sidebarNav.appendChild(btn));\n\n  // Add click event listeners\n  dom.sidebarNav.querySelectorAll(\".nav-item\").forEach((btn) => {\n    btn.addEventListener(\"click\", () => {\n      const type = btn.getAttribute(\"data-type\");\n\n      if (type === \"folder\") {\n        const path = btn.getAttribute(\"data-path\");\n        if (!path) return;\n        const node = findNodeByPath(state.navigationTree, path);\n        if (!node) return;\n\n        navigateToFolder(node);\n        return;\n      }\n\n      if (type === \"module\" || type === \"page\" || type === \"document\") {\n        const id = btn.getAttribute(\"data-id\");\n        if (!id) return;\n        const node = findLeafById(state.navigationTree, id);\n        if (!node) return;\n\n        clearSidebarActive();\n        btn.classList.add(\"active\");\n        openNode(node);\n\n        if (!isDesktopOrTablet() || isLandscapeMode()) {\n          toggleSidebar();\n        }\n      }\n    });\n  });\n\n  // Apply cached width (no measurement needed!)\n  console.log('[Navigation] Applying cached width values');\n  applySidebarWidth();\n}","/**\n * Module preloading system\n * Preloads modules in a folder for better performance\n * Calculates sidebar width from JSON metadata using actual DOM measurement\n */\n\nimport { state, themeController } from '../core/state.js';\nimport { scriptUrlFromFile, factoryNameFromId, extractDisplayNameFromCode } from '../core/utils.js';\nimport { dynamicRender } from '../loader/index.js';\n\n/**\n * Measure actual width needed for label texts using temporary DOM element\n * This ensures accurate measurement matching real CSS\n */\nfunction measureLabelsWidth(labelTexts) {\n  if (labelTexts.length === 0) return 240;\n\n  // Create temporary hidden container\n  const tempContainer = document.createElement('div');\n  tempContainer.style.position = 'absolute';\n  tempContainer.style.left = '-99999px';\n  tempContainer.style.top = '-99999px';\n  tempContainer.style.visibility = 'hidden';\n  tempContainer.style.pointerEvents = 'none';\n  document.body.appendChild(tempContainer);\n\n  let maxLabelWidth = 0;\n\n  labelTexts.forEach(text => {\n    // Create element with exact same styles as real nav-label\n    const label = document.createElement('span');\n    label.className = 'nav-label';\n    label.textContent = text;\n    \n    // Apply critical styles that affect width measurement\n    label.style.fontSize = '1.2rem';\n    label.style.lineHeight = '1.1';\n    label.style.whiteSpace = 'nowrap';\n    label.style.display = 'inline-block';\n    \n    tempContainer.appendChild(label);\n\n    // Force reflow to ensure accurate measurement\n    void label.offsetWidth;\n\n    const width = label.getBoundingClientRect().width;\n    \n    if (width > maxLabelWidth) {\n      maxLabelWidth = width;\n    }\n\n    tempContainer.removeChild(label);\n  });\n\n  document.body.removeChild(tempContainer);\n\n  // Calculate total needed width using your formula:\n  const navIndexWidth = 24;      // \"01\", \"02\" etc\n  const navIconWidth = 24;       // icon + margins\n  const padding = 12;            // sidebar padding\n  const extraMargin = 40;        // safety margin\n  \n  const totalNeeded = navIndexWidth + navIconWidth + maxLabelWidth + padding + extraMargin;\n  \n  console.log('[Preloader] Width measurement:', {\n    maxLabelWidth: Math.ceil(maxLabelWidth),\n    navIndexWidth: navIndexWidth,\n    navIconWidth: navIconWidth,\n    padding: padding,\n    extraMargin: extraMargin,\n    totalNeeded: Math.ceil(totalNeeded)\n  });\n\n  return Math.ceil(totalNeeded);\n}\n\n/**\n * Calculate sidebar width for a folder from JSON metadata\n * Measures actual rendered width using temporary DOM element\n */\nfunction calculateFolderWidth(folderNode) {\n  if (!folderNode || !folderNode.children) return { width: 240, hoverNeeded: false };\n\n  const labelTexts = folderNode.children\n    .map(child => {\n      if (child.type === 'folder') {\n        return child.name || '';\n      } else if (child.type === 'module' || child.type === 'page' || child.type === 'document') {\n        return child.title || child.id || '';\n      }\n      return '';\n    })\n    .filter(text => text.length > 0);\n\n  const width = measureLabelsWidth(labelTexts);\n  const hoverNeeded = width > state.baseSidebarWidth;\n\n  return { width, hoverNeeded };\n}\n\n/**\n * Preload modules in a folder for better performance\n * Width calculation is instant using JSON titles\n */\nexport function preloadFolderModules(folderNode) {\n  if (!folderNode || !folderNode.children) return;\n\n  const folderPath = folderNode.path || 'Home';\n\n  // Calculate and cache width immediately from JSON\n  if (!state.folderWidthCache.has(folderPath)) {\n    const { width, hoverNeeded } = calculateFolderWidth(folderNode);\n    \n    state.folderWidthCache.set(folderPath, { width, hoverNeeded });\n    state.hoverSidebarWidth = width;\n    state.hoverNeeded = hoverNeeded;\n    \n    console.log('[Preloader] Calculated and cached width for', folderPath, ':', {\n      width: width,\n      hoverNeeded: hoverNeeded\n    });\n  } else {\n    const cachedWidth = state.folderWidthCache.get(folderPath);\n    state.hoverSidebarWidth = cachedWidth.width;\n    state.hoverNeeded = cachedWidth.hoverNeeded;\n    console.log('[Preloader] Using cached width for', folderPath);\n  }\n\n  window.dispatchEvent(new CustomEvent('sidebarRenderNeeded', {\n    detail: { folderNode }\n  }));\n  \n  window.dispatchEvent(new CustomEvent('searchIndexRebuildNeeded'));\n\n  // Now preload modules in background (for faster loading when clicked)\n  const modulesToPreload = folderNode.children.filter(\n    (child) => child.type === \"module\" && !state.preloadedModules.has(child.id)\n  );\n  \n  if (modulesToPreload.length === 0) {\n    console.log('[Preloader] No modules to preload for', folderPath);\n    return;\n  }\n\n  console.log('[Preloader] Starting background preload of', modulesToPreload.length, 'modules');\n\n  function preloadNext(index) {\n    if (index >= modulesToPreload.length) {\n      console.log('[Preloader] All modules preloaded');\n      return;\n    }\n\n    const mod = modulesToPreload[index];\n    const scriptSrc = scriptUrlFromFile(mod.file);\n\n    if (state.loadedScripts.has(scriptSrc)) {\n      state.preloadedModules.add(mod.id);\n      if (window.requestIdleCallback) {\n        requestIdleCallback(() => preloadNext(index + 1));\n      } else {\n        Promise.resolve().then(() => preloadNext(index + 1));\n      }\n      return;\n    }\n\n    console.log('[Preloader] Loading module', index + 1, '/', modulesToPreload.length, ':', mod.id);\n\n    // Create Promise for this fetch operation\n    const fetchPromise = fetch(scriptSrc)\n      .then(response => {\n        if (!response.ok) {\n          throw new Error(`Failed to fetch: ${response.status}`);\n        }\n        return response.text();\n      })\n      .then(async (moduleCode) => {\n        state.loadedScripts.add(scriptSrc);\n        \n        // Store code in memory cache for content-loader\n        state.moduleCodeCache.set(scriptSrc, moduleCode);\n        console.log('[Preloader] Cached code for', scriptSrc, '(', moduleCode.length, 'bytes )');\n        \n        // Extract display name from code WITHOUT executing\n        const displayName = extractDisplayNameFromCode(moduleCode);\n        if (displayName) {\n          state.moduleDisplayNames[mod.id] = displayName;\n          console.log('[Preloader] Extracted display name for', mod.id, ':', displayName);\n        }\n        \n        state.preloadedModules.add(mod.id);\n        \n        // Clean up Promise tracker\n        state.preloadPromises.delete(scriptSrc);\n        \n        return moduleCode;\n      })\n      .catch(error => {\n        console.error('[Preloader] Failed to preload module:', scriptSrc, error);\n        state.preloadedModules.add(mod.id);\n        \n        // Clean up Promise tracker\n        state.preloadPromises.delete(scriptSrc);\n        \n        throw error;\n      });\n    \n    // Store Promise so content-loader can await it\n    state.preloadPromises.set(scriptSrc, fetchPromise);\n    \n    // Wait for fetch to complete, then continue\n    fetchPromise\n      .finally(() => {\n        if (window.requestIdleCallback) {\n          requestIdleCallback(() => preloadNext(index + 1));\n        } else {\n          Promise.resolve().then(() => preloadNext(index + 1));\n        }\n      });\n  }\n\n  preloadNext(0);\n}\n\n/**\n * Get initial folder on page load\n */\nexport function getInitialFolder(tree) {\n  return tree;\n}\n\n/**\n * Initialize preloader event listeners\n * Call this from app.js after all modules are loaded\n */\nexport function initPreloader() {\n  // Listen for folder navigation events\n  window.addEventListener('folderNavigated', (event) => {\n    const { folderNode } = event.detail;\n    console.log('[Preloader] Received folderNavigated event');\n    preloadFolderModules(folderNode);\n  });\n  \n  console.log('[Preloader] Event listeners initialized');\n}","/**\n * Search functionality module\n * Handles search indexing, querying, and results display\n */\n\nimport { dom, state } from '../core/state.js';\nimport { findNodeByPath, findParentFolder, isDesktopOrTablet } from '../core/utils.js';\nimport { getTypeIcon } from '../loader/fontawesome-loader.js';\nimport { navigateToFolder } from './navigation.js';\nimport { clearSidebarActive, toggleSidebar } from './sidebar.js';\nimport { openNode } from './content-loader.js';\n\n/**\n * Build searchable index from navigation tree\n */\nexport function buildSearchIndex(node, pathArray = [], parentNode = null) {\n  const index = [];\n\n  if (!node) return index;\n\n  const currentPath = pathArray.length > 0 ? pathArray.join(\" > \") : \"\";\n\n  // Index folders\n  if (node.type === \"folder\" && node.name) {\n    index.push({\n      type: \"folder\",\n      name: node.name,\n      path: node.path,\n      displayPath: currentPath,\n      searchText: node.name.toLowerCase(),\n      node: node,\n      parentNode: parentNode\n    });\n  }\n\n  // Index modules, pages, documents\n  if (node.type === \"module\" || node.type === \"page\" || node.type === \"document\") {\n    const title = state.moduleDisplayNames[node.id] || node.title || node.id || \"\";\n    const tags = (node.tags || []).join(\" \").toLowerCase();\n\n    index.push({\n      type: node.type,\n      id: node.id,\n      title: title,\n      path: node.path,\n      displayPath: currentPath,\n      searchText: (title + \" \" + tags).toLowerCase(),\n      node: node,\n      parentNode: parentNode\n    });\n  }\n\n  // Recursively index children\n  if (node.children && node.children.length > 0) {\n    const newPath = node.name ? [...pathArray, node.name] : pathArray;\n    node.children.forEach(child => {\n      index.push(...buildSearchIndex(child, newPath, node));\n    });\n  }\n\n  return index;\n}\n\n/**\n * Rebuild the search index\n */\nexport function rebuildSearchIndex() {\n  if (!state.navigationTree) return;\n  state.searchIndex = buildSearchIndex(state.navigationTree);\n  console.log('[Search] Index rebuilt with', state.searchIndex.length, 'items');\n}\n\n/**\n * Score a search match\n */\nfunction scoreMatch(searchText, query) {\n  const lowerQuery = query.toLowerCase();\n  const lowerText = searchText.toLowerCase();\n\n  // Exact match gets highest score\n  if (lowerText === lowerQuery) return 1000;\n\n  // Starts with query\n  if (lowerText.startsWith(lowerQuery)) return 500;\n\n  // Contains query as whole word\n  const words = lowerText.split(/\\s+/);\n  for (const word of words) {\n    if (word.startsWith(lowerQuery)) return 300;\n    if (word.includes(lowerQuery)) return 150;\n  }\n\n  // Contains query anywhere (substring match)\n  if (lowerText.includes(lowerQuery)) return 100;\n\n  return 0;\n}\n\n/**\n * Search items in the index\n */\nfunction searchItems(query) {\n  if (!query || query.trim().length < 2) return [];\n\n  const trimmedQuery = query.trim();\n  const results = [];\n\n  state.searchIndex.forEach(item => {\n    const score = scoreMatch(item.searchText, trimmedQuery);\n    if (score > 0) {\n      results.push({ ...item, score });\n    }\n  });\n\n  // Sort by score (highest first), then alphabetically\n  results.sort((a, b) => {\n    if (b.score !== a.score) return b.score - a.score;\n    const aName = a.title || a.name || \"\";\n    const bName = b.title || b.name || \"\";\n    return aName.localeCompare(bName);\n  });\n\n  return results.slice(0, 15);\n}\n\n/**\n * Highlight matching text in search results\n */\nfunction highlightMatch(text, query) {\n  if (!query || !text) return text;\n\n  const lowerText = text.toLowerCase();\n  const lowerQuery = query.toLowerCase();\n  const index = lowerText.indexOf(lowerQuery);\n\n  if (index === -1) return text;\n\n  const before = text.substring(0, index);\n  const match = text.substring(index, index + query.length);\n  const after = text.substring(index + query.length);\n\n  return before + '<span class=\"search-match\">' + match + '</span>' + after;\n}\n\n/**\n * Render search results\n */\nfunction renderSearchResults(results, query) {\n  state.selectedResultIndex = -1;\n\n  if (results.length === 0) {\n    dom.searchResults.innerHTML = '<div class=\"search-no-results\">No results found</div>';\n    dom.searchResults.style.display = \"block\";\n    return;\n  }\n\n  const html = results.map((item, index) => {\n    const displayName = item.title || item.name || \"\";\n    const highlightedName = highlightMatch(displayName, query);\n    const icon = getTypeIcon(item.type);\n\n    return `\n      <div class=\"search-result-item\" data-index=\"${index}\">\n        <div class=\"search-result-title\">\n          <span class=\"search-result-icon\">${icon}</span>\n          <span>${highlightedName}</span>\n        </div>\n        ${item.displayPath ? `<div class=\"search-result-path\">${item.displayPath}</div>` : \"\"}\n      </div>\n    `;\n  }).join(\"\");\n\n  dom.searchResults.innerHTML = html;\n  dom.searchResults.style.display = \"block\";\n\n  // Add click listeners\n  dom.searchResults.querySelectorAll(\".search-result-item\").forEach((el, index) => {\n    el.addEventListener(\"click\", () => {\n      handleResultSelection(results[index]);\n    });\n  });\n}\n\n/**\n * Handle selection of a search result\n */\nfunction handleResultSelection(item) {\n  console.log('[Search] Selected item:', item);\n  \n  if (!item || !item.node) {\n    console.error('[Search] Invalid item or node');\n    return;\n  }\n\n  if (item.type === \"folder\") {\n    // Navigate to folder using unified function\n    console.log('[Search] Navigating to folder:', item.node.path);\n    navigateToFolder(item.node);\n  } else {\n    // For modules/pages/documents - use stored parent from index\n    let parentNode = item.parentNode;\n    \n    console.log('[Search] Item details:', {\n      itemType: item.type,\n      itemPath: item.path,\n      itemNode: item.node,\n      parentNode: parentNode\n    });\n\n    if (parentNode && parentNode.type === 'folder') {\n      console.log('[Search] Navigating to parent folder:', parentNode.path || 'Home');\n      \n      // Navigate to parent folder (triggers all folder navigation actions)\n      navigateToFolder(parentNode);\n      \n      // Wait for folder navigation to complete, then open the item\n      requestAnimationFrame(() => {\n        console.log('[Search] Opening item:', item.node.id);\n        clearSidebarActive();\n        openNode(item.node);\n\n        // Highlight the active item in sidebar after opening\n        requestAnimationFrame(() => {\n          requestAnimationFrame(() => {\n            const navItem = dom.sidebarNav.querySelector(\n              '.nav-item[data-type=\"' + item.node.type + '\"][data-id=\"' + item.node.id + '\"]'\n            );\n            if (navItem) {\n              navItem.classList.add(\"active\");\n              console.log('[Search] Activated nav item');\n            } else {\n              console.warn('[Search] Could not find nav item for', item.node.id);\n            }\n          });\n        });\n      });\n    } else {\n      console.error('[Search] Could not find valid parent folder');\n    }\n  }\n\n  // Clear search UI\n  dom.searchInput.value = \"\";\n  dom.searchClear.style.display = \"none\";\n  dom.searchResults.style.display = \"none\";\n  dom.searchResults.innerHTML = \"\";\n\n  // Close sidebar on mobile\n  if (!isDesktopOrTablet()) {\n    requestAnimationFrame(() => {\n      requestAnimationFrame(() => toggleSidebar());\n    });\n  }\n}\n\n/**\n * Update selected result with keyboard navigation\n */\nfunction updateSelectedResult(direction) {\n  const items = dom.searchResults.querySelectorAll(\".search-result-item\");\n  if (items.length === 0) return;\n\n  // Remove previous selection\n  if (state.selectedResultIndex >= 0 && state.selectedResultIndex < items.length) {\n    items[state.selectedResultIndex].classList.remove(\"selected\");\n  }\n\n  // Update index\n  if (direction === \"down\") {\n    state.selectedResultIndex = (state.selectedResultIndex + 1) % items.length;\n  } else if (direction === \"up\") {\n    state.selectedResultIndex = state.selectedResultIndex <= 0 ? items.length - 1 : state.selectedResultIndex - 1;\n  }\n\n  // Add new selection\n  if (state.selectedResultIndex >= 0 && state.selectedResultIndex < items.length) {\n    items[state.selectedResultIndex].classList.add(\"selected\");\n    items[state.selectedResultIndex].scrollIntoView({ block: \"nearest\" });\n  }\n}\n\n/**\n * Initialize search functionality\n */\nexport function initSearch() {\n  let searchDebounceTimer = null;\n\n  dom.searchInput.addEventListener(\"input\", (e) => {\n    const query = e.target.value;\n\n    // Show/hide clear button\n    dom.searchClear.style.display = query.length > 0 ? \"flex\" : \"none\";\n\n    // Debounce search\n    clearTimeout(searchDebounceTimer);\n\n    if (query.trim().length === 0) {\n      dom.searchResults.style.display = \"none\";\n      dom.searchResults.innerHTML = \"\";\n      return;\n    }\n\n    searchDebounceTimer = setTimeout(() => {\n      const results = searchItems(query);\n      renderSearchResults(results, query);\n    }, 200);\n  });\n\n  dom.searchInput.addEventListener(\"keydown\", (e) => {\n    const resultsVisible = dom.searchResults.style.display === \"block\";\n\n    if (e.key === \"Escape\") {\n      dom.searchInput.value = \"\";\n      dom.searchClear.style.display = \"none\";\n      dom.searchResults.style.display = \"none\";\n      dom.searchResults.innerHTML = \"\";\n      dom.searchInput.blur();\n    } else if (e.key === \"ArrowDown\" && resultsVisible) {\n      e.preventDefault();\n      updateSelectedResult(\"down\");\n    } else if (e.key === \"ArrowUp\" && resultsVisible) {\n      e.preventDefault();\n      updateSelectedResult(\"up\");\n    } else if (e.key === \"Enter\" && resultsVisible) {\n      e.preventDefault();\n      const results = searchItems(dom.searchInput.value);\n      if (state.selectedResultIndex >= 0 && state.selectedResultIndex < results.length) {\n        handleResultSelection(results[state.selectedResultIndex]);\n      } else if (results.length > 0) {\n        handleResultSelection(results[0]);\n      }\n    }\n  });\n\n  dom.searchClear.addEventListener(\"click\", () => {\n    dom.searchInput.value = \"\";\n    dom.searchClear.style.display = \"none\";\n    dom.searchResults.style.display = \"none\";\n    dom.searchResults.innerHTML = \"\";\n    dom.searchInput.focus();\n  });\n\n  // Close Search Results When Clicking Outside\n  document.addEventListener(\"click\", (e) => {\n    if (!dom.searchInput.contains(e.target) &&\n        !dom.searchResults.contains(e.target) &&\n        !dom.searchClear.contains(e.target)) {\n      if (dom.searchResults.style.display === \"block\") {\n        dom.searchResults.style.display = \"none\";\n      }\n    }\n  });\n}\n\n/**\n * Initialize search event listeners\n * Call this from app.js after all modules are loaded\n */\nexport function initSearchEventListeners() {\n  // Listen for search index rebuild requests\n  window.addEventListener('searchIndexRebuildNeeded', () => {\n    console.log('[Search] Received searchIndexRebuildNeeded event');\n    rebuildSearchIndex();\n  });\n  \n  // Listen for sidebar render requests (to rebuild search index after)\n  window.addEventListener('sidebarRenderNeeded', (event) => {\n    const { folderNode } = event.detail;\n    console.log('[Search] Received sidebarRenderNeeded event');\n    // Import and call renderSidebar dynamically to avoid circular dependency at module load time\n    import('./navigation.js').then(nav => {\n      nav.renderSidebar(folderNode);\n    });\n  });\n  \n  console.log('[Search] Event listeners initialized');\n}","/**\n * Detects notch position in landscape mode and applies appropriate CSS class\n */\n\nexport function initSafeAreaDetector() {\n  /**\n   * Wait for layout stabilization using requestAnimationFrame\n   * @param {number} frames - Number of frames to wait (1 frame ≈ 16.67ms at 60fps)\n   * @returns {Promise<void>}\n   */\n  function waitForLayout(frames = 1) {\n    return new Promise(resolve => {\n      let count = 0;\n      function tick() {\n        count++;\n        if (count >= frames) {\n          resolve();\n        } else {\n          requestAnimationFrame(tick);\n        }\n      }\n      requestAnimationFrame(tick);\n    });\n  }\n\n  function detectNotchPosition() {\n    // Only run in landscape mode\n    const isLandscape = window.matchMedia('(max-height: 600px) and (orientation: landscape)').matches;\n    \n    if (!isLandscape) {\n      document.documentElement.removeAttribute('data-notch-side');\n      console.log('[SafeArea] Not in landscape mode');\n      return;\n    }\n\n    // Method 1: Use screen.orientation.angle\n    // 90 = notch on left, 270/-90 = notch on right\n    let angle = 0;\n    \n    if (window.screen && window.screen.orientation) {\n      angle = window.screen.orientation.angle;\n    } else if (window.orientation !== undefined) {\n      angle = window.orientation;\n    }\n    \n    console.log('[SafeArea] Orientation angle:', angle);\n    \n    // Determine notch side based on angle\n    // Most devices: 90° = rotated left (notch on left), -90°/270° = rotated right (notch on right)\n    if (angle === 90) {\n      document.documentElement.setAttribute('data-notch-side', 'left');\n      console.log('[SafeArea] Angle 90° - Notch on LEFT');\n    } else if (angle === -90 || angle === 270) {\n      document.documentElement.setAttribute('data-notch-side', 'right');\n      console.log('[SafeArea] Angle -90°/270° - Notch on RIGHT');\n    } else {\n      // Fallback: Try measuring safe areas\n      console.log('[SafeArea] Unknown angle, measuring safe areas...');\n      measureSafeAreas();\n    }\n  }\n\n  function measureSafeAreas() {\n    // Use getComputedStyle on root element with CSS variables\n    const root = document.documentElement;\n    \n    // Set CSS custom properties to read env() values\n    root.style.setProperty('--test-safe-left', 'env(safe-area-inset-left, 0px)');\n    root.style.setProperty('--test-safe-right', 'env(safe-area-inset-right, 0px)');\n    \n    const computedStyle = getComputedStyle(root);\n    const leftValue = computedStyle.getPropertyValue('--test-safe-left').trim();\n    const rightValue = computedStyle.getPropertyValue('--test-safe-right').trim();\n    \n    console.log('[SafeArea] Computed left:', leftValue, 'right:', rightValue);\n    \n    // Parse pixel values\n    const leftPx = parseFloat(leftValue) || 0;\n    const rightPx = parseFloat(rightValue) || 0;\n    \n    console.log('[SafeArea] Parsed left:', leftPx, 'right:', rightPx);\n    \n    if (leftPx > 20) {\n      document.documentElement.setAttribute('data-notch-side', 'left');\n      console.log('[SafeArea] Measured - Notch on LEFT');\n    } else if (rightPx > 20) {\n      document.documentElement.setAttribute('data-notch-side', 'right');\n      console.log('[SafeArea] Measured - Notch on RIGHT');\n    } else {\n      document.documentElement.setAttribute('data-notch-side', 'none');\n      console.log('[SafeArea] Measured - No notch detected');\n    }\n    \n    // Clean up\n    root.style.removeProperty('--test-safe-left');\n    root.style.removeProperty('--test-safe-right');\n  }\n\n  // Initial detection\n  waitForLayout(12).then(detectNotchPosition);\n\n  // Re-detect on orientation change\n  if (window.screen && window.screen.orientation) {\n    window.screen.orientation.addEventListener('change', () => {\n      console.log('[SafeArea] Screen orientation changed');\n      waitForLayout(18).then(detectNotchPosition);\n    });\n  }\n\n  // Fallback: orientationchange event\n  window.addEventListener('orientationchange', () => {\n    console.log('[SafeArea] Orientation change event fired');\n    waitForLayout(18).then(detectNotchPosition);\n  });\n\n  // Backup: resize event\n  let resizeAbortController = null;\n  window.addEventListener('resize', async () => {\n    // Cancel previous resize detection\n    if (resizeAbortController) {\n      resizeAbortController.abort();\n    }\n    \n    resizeAbortController = new AbortController();\n    const signal = resizeAbortController.signal;\n    \n    try {\n      // Wait ~250ms (15 frames at 60fps)\n      await Promise.race([\n        waitForLayout(15),\n        new Promise((_, reject) => {\n          signal.addEventListener('abort', () => reject(new Error('aborted')));\n        })\n      ]);\n      \n      if (!signal.aborted) {\n        console.log('[SafeArea] Resize detected, checking orientation');\n        detectNotchPosition();\n      }\n    } catch (err) {\n      // Resize was cancelled by newer event\n    }\n  });\n}\n","/**\n * PWA Detection and Service Worker Registration Utility\n * \n * CRITICAL: Only registers service worker when running as installed PWA\n * Specifically designed for iOS Safari PWA detection\n * \n * Includes debug logging for troubleshooting\n */\n\n/**\n * Detect if app is running as installed PWA\n * @returns {boolean} True if running as PWA\n */\nexport function isPWA() {\n  // Method 1: iOS Safari PWA detection\n  if (window.navigator.standalone === true) {\n    console.log('[PWA] Detected: iOS standalone mode');\n    return true;\n  }\n\n  // Method 2: Standard display-mode detection\n  if (window.matchMedia('(display-mode: standalone)').matches) {\n    console.log('[PWA] Detected: display-mode standalone');\n    return true;\n  }\n\n  // Method 3: Fullscreen mode (Android)\n  if (window.matchMedia('(display-mode: fullscreen)').matches) {\n    console.log('[PWA] Detected: display-mode fullscreen');\n    return true;\n  }\n\n  // Method 4: Minimal UI mode\n  if (window.matchMedia('(display-mode: minimal-ui)').matches) {\n    console.log('[PWA] Detected: display-mode minimal-ui');\n    return true;\n  }\n\n  console.log('[PWA] Not detected: Running in browser');\n  return false;\n}\n\n/**\n * Get PWA display mode\n * @returns {string} Display mode\n */\nexport function getPWADisplayMode() {\n  if (window.navigator.standalone === true) {\n    return 'standalone';\n  }\n  if (window.matchMedia('(display-mode: standalone)').matches) {\n    return 'standalone';\n  }\n  if (window.matchMedia('(display-mode: fullscreen)').matches) {\n    return 'fullscreen';\n  }\n  if (window.matchMedia('(display-mode: minimal-ui)').matches) {\n    return 'minimal-ui';\n  }\n  return 'browser';\n}\n\n/**\n * Show progress indicator during service worker installation\n */\nfunction showCacheProgress() {\n  const overlay = document.createElement('div');\n  overlay.id = 'pwa-cache-overlay';\n  overlay.style.cssText = `\n    position: fixed;\n    top: 0;\n    left: 0;\n    width: 100%;\n    height: 100%;\n    background: rgba(31, 31, 31, 0.95);\n    display: flex;\n    flex-direction: column;\n    justify-content: center;\n    align-items: center;\n    z-index: 10000;\n    font-family: 'Uni Sans', sans-serif;\n  `;\n\n  overlay.innerHTML = `\n    <div style=\"text-align: center; max-width: 80%; color: #ffffff;\">\n      <div style=\"font-size: 1.5rem; margin-bottom: 1rem; font-weight: 600;\">\n        ⚡ Preparing Full Offline Mode\n      </div>\n      <div style=\"font-size: 0.9rem; margin-bottom: 2rem; color: #cccccc;\">\n        Caching ALL assets for complete offline access...<br>\n        This may take 30-60 seconds on first install\n      </div>\n      <div style=\"width: 100%; max-width: 300px; height: 8px; background: rgba(255,255,255,0.2); border-radius: 4px; overflow: hidden;\">\n        <div id=\"pwa-progress-bar\" style=\"width: 0%; height: 100%; background: linear-gradient(90deg, #4CAF50, #8BC34A); transition: width 0.3s ease;\"></div>\n      </div>\n      <div id=\"pwa-progress-text\" style=\"margin-top: 1rem; font-size: 0.8rem; color: #999;\">\n        0%\n      </div>\n      <div id=\"pwa-progress-detail\" style=\"margin-top: 0.5rem; font-size: 0.7rem; color: #666; min-height: 1rem;\">\n        Starting...\n      </div>\n    </div>\n  `;\n\n  document.body.appendChild(overlay);\n  return overlay;\n}\n\n/**\n * Update progress bar\n */\nfunction updateProgress(progress, current, total, url) {\n  const progressBar = document.getElementById('pwa-progress-bar');\n  const progressText = document.getElementById('pwa-progress-text');\n  const progressDetail = document.getElementById('pwa-progress-detail');\n\n  if (progressBar) {\n    progressBar.style.width = progress + '%';\n  }\n  if (progressText) {\n    progressText.textContent = `${progress}% (${current}/${total})`;\n  }\n  if (progressDetail && url) {\n    const fileName = url.split('/').pop() || url;\n    const shortName = fileName.length > 40 ? fileName.substring(0, 37) + '...' : fileName;\n    progressDetail.textContent = shortName;\n  }\n}\n\n/**\n * Remove progress overlay\n */\nfunction hideProgress() {\n  const overlay = document.getElementById('pwa-cache-overlay');\n  if (overlay) {\n    overlay.style.opacity = '0';\n    overlay.style.transition = 'opacity 0.5s ease';\n    setTimeout(() => overlay.remove(), 500);\n  }\n}\n\n/**\n * Register service worker (only if PWA)\n * @returns {Promise<boolean>} True if registered successfully\n */\nexport async function registerServiceWorker() {\n  // Debug logging\n  console.log('[PWA Debug] === Service Worker Registration Debug ===');\n  console.log('[PWA Debug] Protocol:', window.location.protocol);\n  console.log('[PWA Debug] Hostname:', window.location.hostname);\n  console.log('[PWA Debug] Port:', window.location.port);\n  console.log('[PWA Debug] Secure context:', window.isSecureContext);\n  console.log('[PWA Debug] Service worker available:', 'serviceWorker' in navigator);\n  console.log('[PWA Debug] Navigator standalone:', window.navigator.standalone);\n  console.log('[PWA Debug] Display mode:', getPWADisplayMode());\n  console.log('[PWA Debug] isPWA():', isPWA());\n\n  // CRITICAL: Only register if running as PWA\n  if (!isPWA()) {\n    console.log('[PWA] Service worker NOT registered: Not running as PWA');\n    return false;\n  }\n\n  if (!('serviceWorker' in navigator)) {\n    console.warn('[PWA] Service worker not supported in this browser');\n    console.warn('[PWA] Possible causes:');\n    console.warn('[PWA]   - Not HTTPS (requires HTTPS or localhost)');\n    console.warn('[PWA]   - Browser too old');\n    console.warn('[PWA]   - Private browsing mode');\n    return false;\n  }\n\n  if (!window.isSecureContext) {\n    console.error('[PWA] Not a secure context (HTTPS required)');\n    console.error('[PWA] Current protocol:', window.location.protocol);\n    console.error('[PWA] Service worker registration blocked');\n    return false;\n  }\n\n  console.log('[PWA] Registering service worker...');\n\n  try {\n    // Check if this is first installation\n    const registrations = await navigator.serviceWorker.getRegistrations();\n    const isFirstInstall = registrations.length === 0;\n\n    console.log('[PWA Debug] Existing registrations:', registrations.length);\n    console.log('[PWA] First install:', isFirstInstall);\n\n    let progressOverlay = null;\n    if (isFirstInstall) {\n      progressOverlay = showCacheProgress();\n      console.log('[PWA] First install - showing progress overlay');\n      console.log('[PWA] ⏳ This will take 30-60 seconds to cache everything');\n    }\n\n    // Listen for progress messages\n    navigator.serviceWorker.addEventListener('message', (event) => {\n      if (event.data && event.data.type === 'CACHE_PROGRESS') {\n        updateProgress(\n          event.data.progress,\n          event.data.current,\n          event.data.total,\n          event.data.url\n        );\n      }\n\n      if (event.data && event.data.type === 'CACHE_COMPLETE') {\n        console.log('[PWA] ✅ Cache complete!');\n        console.log('[PWA] Total:', event.data.totalAssets);\n        console.log('[PWA] Cached:', event.data.cachedAssets);\n        if (event.data.failedAssets > 0) {\n          console.warn('[PWA] Failed:', event.data.failedAssets);\n        }\n        setTimeout(() => hideProgress(), 1000);\n      }\n    });\n\n    // Register service worker\n    const registration = await navigator.serviceWorker.register('./service-worker.js', {\n      scope: './'\n    });\n\n    console.log('[PWA] Service worker registered');\n    console.log('[PWA Debug] Scope:', registration.scope);\n    console.log('[PWA Debug] Active:', !!registration.active);\n    console.log('[PWA Debug] Installing:', !!registration.installing);\n    console.log('[PWA Debug] Waiting:', !!registration.waiting);\n\n    // Request persistent storage\n    if (navigator.storage && navigator.storage.persist) {\n      const isPersisted = await navigator.storage.persist();\n      if (isPersisted) {\n        console.log('[PWA] ✅ Persistent storage granted');\n      } else {\n        console.warn('[PWA] ⚠️  Persistent storage denied (cache may be evicted)');\n      }\n\n      // Check storage estimate\n      if (navigator.storage.estimate) {\n        const estimate = await navigator.storage.estimate();\n        console.log('[PWA Debug] Storage usage:', Math.round(estimate.usage / 1024 / 1024) + ' MB');\n        console.log('[PWA Debug] Storage quota:', Math.round(estimate.quota / 1024 / 1024) + ' MB');\n      }\n    }\n\n    // Handle updates\n    registration.addEventListener('updatefound', () => {\n      const newWorker = registration.installing;\n      console.log('[PWA] New service worker found, installing...');\n\n      newWorker.addEventListener('statechange', () => {\n        console.log('[PWA Debug] Worker state:', newWorker.state);\n        if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {\n          console.log('[PWA] New service worker installed, update available');\n        }\n      });\n    });\n\n    if (!isFirstInstall && progressOverlay) {\n      hideProgress();\n    }\n\n    return true;\n  } catch (error) {\n    console.error('[PWA] Service worker registration failed:', error);\n    console.error('[PWA Debug] Error name:', error.name);\n    console.error('[PWA Debug] Error message:', error.message);\n    hideProgress();\n    return false;\n  }\n}\n\n/**\n * Check if app is ready for offline use\n * @returns {Promise<boolean>}\n */\nexport async function isOfflineReady() {\n  if (!('serviceWorker' in navigator)) {\n    return false;\n  }\n\n  const registration = await navigator.serviceWorker.getRegistration();\n  if (!registration || !registration.active) {\n    return false;\n  }\n\n  const cacheNames = await caches.keys();\n  return cacheNames.some(name => name.startsWith('unstablon-offline-'));\n}\n\nconsole.log('[PWA] PWA detector utility loaded');\n","/**\n * Main application entry point\n * Orchestrates all modules and handles initialization\n */\n\nimport { dom, state, initDOMRefs } from './core/state.js';\nimport { notifyModuleReady, isDesktopOrTablet, isMediumViewport, shouldAutoCloseSidebar } from './core/utils.js';\nimport { initTheme } from './modules/theme.js';\nimport { initSidebar, toggleSidebar } from './modules/sidebar.js';\nimport { renderSidebar } from './modules/navigation.js';\nimport { openNode } from './modules/content-loader.js';\nimport { preloadFolderModules, getInitialFolder } from './modules/preloader.js';\nimport { rebuildSearchIndex } from './modules/search.js'; \nimport { initSafeAreaDetector } from './modules/safe-area-detector.js';\nimport { initKeyboardShortcuts } from './modules/keyboard-shortcuts.js'; \nimport * as MathJaxUtil from './loader/mathjax-loader.js';\nimport { isPWA, getPWADisplayMode, registerServiceWorker } from './modules/pwa.js';\n\n(function () {\n  \"use strict\";\n\n  console.log('[App] Initializing application...');\n\n  // Conditionally load manifest to prevent Opera GX icon fetching bug\n  function loadManifestConditionally() {\n    const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);\n    const isAlreadyPWA = isPWA();\n    \n    if (isMobile || isAlreadyPWA) {\n      const link = document.createElement('link');\n      link.rel = 'manifest';\n      link.href = './manifest.json';\n      document.head.appendChild(link);\n      console.log('[App] Manifest loaded (mobile or PWA mode)');\n    } else {\n      console.log('[App] Manifest skipped (desktop browser mode - prevents icon spam)');\n    }\n  }\n\n  // Load manifest conditionally FIRST\n  loadManifestConditionally();\n\n  // PWA detection and service worker registration\n  if (isPWA()) {\n    console.log('[App] Running as PWA in', getPWADisplayMode(), 'mode');\n    registerServiceWorker().then(registered => {\n      if (registered) {\n        console.log('[App] PWA offline mode enabled');\n      }\n    }).catch(error => {\n      console.error('[App] PWA initialization failed:', error);\n    });\n  } else {\n    console.log('[App] Running in browser mode (service worker disabled)');\n  }\n\n  // Register global module ready notification\n  window.__moduleReady = notifyModuleReady;\n\n  // Expose MathJax utility globally for non-module scripts (e.g., preloaded calculators)\n  window.MathJaxUtility = MathJaxUtil;\n  console.log('[App] MathJax utility exposed globally');\n\n  /**\n   * Initialize application on page load\n   */\n  window.addEventListener(\"load\", async () => {\n    console.log('[App] Page loaded, initializing DOM references');\n\n    // Initialize DOM references first\n    initDOMRefs();\n    initSafeAreaDetector();\n\n    // Initialize all modules (await theme to ensure assets are preloaded)\n    await initTheme();\n    initSidebar();\n    initKeyboardShortcuts(); \n\n    console.log('[App] Fetching navigation tree');\n\n    // Load navigation tree from static JSON\n    fetch(\"./javascript/tree.json\")\n      .then((res) => {\n        if (!res.ok) {\n          throw new Error(\"Failed to load navigation tree\");\n        }\n        return res.json();\n      })\n      .then(async (tree) => { \n        console.log('[App] Navigation tree loaded');\n        state.navigationTree = tree;\n\n        const initialFolder = getInitialFolder(state.navigationTree);\n\n        await renderSidebar(initialFolder); \n        preloadFolderModules(initialFolder);\n\n        // Build search index after tree is loaded\n        rebuildSearchIndex();\n\n        const { initPreloader } = await import('./modules/preloader.js');\n        const { initSearchEventListeners } = await import('./modules/search.js');\n        \n        initPreloader();\n        initSearchEventListeners();\n        \n        console.log('[App] Event-driven module communication initialized');\n\n        // Default node: first module/page/document directly under that folder\n        let defaultNode = null;\n        if (initialFolder.children) {\n          defaultNode =\n            initialFolder.children.find(\n              (c) =>\n                c.type === \"module\" ||\n                c.type === \"page\" ||\n                c.type === \"document\"\n            ) || null;\n        }\n\n        if (defaultNode) {\n          const defaultBtn = dom.sidebarNav.querySelector(\n            '.nav-item[data-type=\"' +\n              defaultNode.type +\n              '\"][data-id=\"' +\n              defaultNode.id +\n              '\"]'\n          );\n          if (defaultBtn) {\n            defaultBtn.classList.add(\"active\");\n          }\n          openNode(defaultNode);\n        } else {\n          dom.card.classList.remove(\"preload\");\n          dom.card.classList.add(\"loaded\");\n        }\n      })\n      .catch((err) => {\n        console.error('[App] Failed to load navigation tree:', err);\n        dom.card.classList.remove(\"preload\");\n        dom.card.classList.add(\"loaded\");\n      });\n  });\n\n  /**\n   * Handle window resize\n   */\n  window.addEventListener(\"resize\", () => {\n    if (!isDesktopOrTablet()) {\n      dom.sidebar.style.width = \"\";\n    } else {\n      if (dom.sidebar.getAttribute(\"data-open\") === \"true\") {\n        dom.sidebar.style.width = state.baseSidebarWidth + \"px\";\n      } else {\n        dom.sidebar.style.width = \"\";\n      }\n    }\n  });\n\n  /**\n   * Auto-collapse sidebar when clicking on main content (for medium viewports/tablets)\n   */\n  document.addEventListener(\"DOMContentLoaded\", () => {\n    initDOMRefs();\n\n    if (dom.card) {\n      dom.card.addEventListener(\"click\", () => {\n        // ← CHANGED: Use dynamic overlap detection function\n        if (shouldAutoCloseSidebar() && dom.sidebar.getAttribute(\"data-open\") === \"true\") {\n          toggleSidebar();\n        }\n      });\n    }\n\n    if (dom.mainContent) {\n      dom.mainContent.addEventListener(\"click\", (e) => {\n        if (e.target === dom.mainContent || e.target.classList.contains(\"page-root\")) {\n          // ← CHANGED: Use dynamic overlap detection function\n          if (shouldAutoCloseSidebar() && dom.sidebar.getAttribute(\"data-open\") === \"true\") {\n            toggleSidebar();\n          }\n        }\n      });\n    }\n  });\n\n  console.log('[App] Initialization complete');\n})();\n","// FILE: javascript/modules/keyboard-shortcuts.js | NEW FILE\n\n/**\n * Centralized keyboard shortcut management\n * Handles all global keyboard shortcuts for the application\n */\n\nimport { dom } from '../core/state.js';\nimport { toggleSidebar, isSidebarContentInitialized } from './sidebar.js';\n\n/**\n * Initialize all keyboard shortcuts\n * Call early in app.js to register shortcuts before lazy-loaded modules\n */\nexport function initKeyboardShortcuts() {\n  console.log('[Shortcuts] Initializing keyboard shortcuts');\n\n  // Ctrl+K or Cmd+K: Focus Search\n  document.addEventListener(\"keydown\", async (e) => {\n    if ((e.ctrlKey || e.metaKey) && e.key === \"k\") {\n      e.preventDefault();\n      \n      // Open sidebar if closed (triggers lazy loading of search UI)\n      if (dom.sidebar.getAttribute(\"data-open\") !== \"true\") {\n        await toggleSidebar();\n      }\n      \n      // Wait for search UI to be initialized (if first time)\n      // Give time for lazy loading to complete\n      await new Promise(resolve => {\n        if (isSidebarContentInitialized()) {\n          resolve();\n        } else {\n          // Wait for next frame after sidebar opens\n          requestAnimationFrame(() => {\n            requestAnimationFrame(resolve);\n          });\n        }\n      });\n      \n      // Focus search input\n      if (dom.searchInput) {\n        dom.searchInput.focus();\n        console.log('[Shortcuts] Search focused via Ctrl+K');\n      }\n    }\n  });\n\n  console.log('[Shortcuts] Registered: Ctrl+K (Focus Search)');\n}\n\n// Future shortcuts can be added here:\n// registerShortcut('Ctrl+N', 'New note', () => { ... });\n// registerShortcut('Ctrl+/', 'Toggle help', () => { ... });"],"names":["state","activeInstance","activeNode","baseSidebarWidth","hoverSidebarWidth","contentMaxWidth","hoverNeeded","searchIndex","selectedResultIndex","moduleDisplayNames","preloadedModules","Set","navigationTree","currentFolder","loadedScripts","moduleFactories","Map","moduleReadyCallbacks","folderWidthCache","moduleCodeCache","preloadPromises","themeController","getTheme","document","documentElement","getAttribute","subscribe","fn","addEventListener","removeEventListener","dom","htmlEl","sidebar","sidebarToggle","sidebarNav","sidebarBreadcrumb","card","themeToggleBtn","themeIcon","searchInput","searchClear","searchResults","mainContent","initDOMRefs","getElementById","querySelector","findNodeByPath","node","path","children","child","found","findLeafById","id","type","isDesktopOrTablet","window","innerWidth","shouldAutoCloseSidebar","matchMedia","matches","sidebarWidth","minWidthNoOverlap","scriptUrlFromFile","filePath","factoryNameFromId","charAt","toUpperCase","slice","notifyModuleReady","factoryName","callbacks","get","factory","forEach","cb","delete","platformResources","registerPlatformResource","config","url","content","integrity","name","console","error","has","resource","loaded","set","markResourceLoaded","resourceId","loadedResources","fontAwesomeLoadPromise","async","loadFontAwesome","Promise","resolve","faURL","crossorigin","reject","link","createElement","rel","href","crossOrigin","onload","add","onerror","Error","head","appendChild","loadCSS","then","catch","getTypeIcon","imageCache","animationInProgress","setThemeMetaColor","theme","themeColorMeta","setAttribute","replaceWithCachedImage","targetImg","cacheKey","fallbackSrc","cachedImg","complete","naturalWidth","src","newImg","cloneNode","Array","from","attributes","attr","value","className","style","pointerEvents","userSelect","parentNode","replaceChild","warn","cleanupAnimation","element","handler","willChange","once","toggleTheme","next","innerHTML","landscapeThemeIcon","headerLogo","headerBanner","headerTagline","landscapeLogo","classList","remove","offsetWidth","animation","bannerKey","bannerFallback","requestAnimationFrame","setTimeout","updateThemeAssets","event","CustomEvent","detail","dispatchEvent","onThemeChange","initTheme","loadPromises","key","map","img","Image","all","preloadThemeImages","landscapeThemeToggle","initialTheme","isCurrentlyHovering","sidebarContentInitialized","isLandscapeMode","applySidebarWidth","width","toggleSidebar","searchContainer","initSearch","initSidebarSearch","String","landscapeToggle","currentWidth","getBoundingClientRect","e","propertyName","clearSidebarActive","querySelectorAll","b","handleSidebarMouseEnter","handleSidebarMouseLeave","related","relatedTarget","contains","initSidebar","isSidebarContentInitialized","mathJaxLoaded","mathJaxLoadingPromise","loadMathJax","MathJax","tex","inlineMath","displayMath","chtml","fontURL","options","skipHtmlTags","startup","ready","defaultReady","script","typesetMath","container","typesetPromise","dynamicRender","rerenderPromises","html","test","push","length","messageTunnel","constructor","this","subscribers","messageLog","send","fromInstanceId","toInstanceId","message","timestamp","Date","now","to","size","envelope","callback","broadcast","instanceId","unsubscribe","createInstanceAPI","onMessage","getMessageLog","clearMessageLog","instanceManager","instances","compartments","metadata","hierarchy","register","instance","moduleId","parentId","cardId","rootElement","createdAt","destroy","_getDescendants","reverse","data","destroyCompartment","descendants","childId","generateInstanceId","parentInstanceId","basePath","index","candidateId","registerCompartment","compartment","getCompartment","routeMessage","getInstanceById","clear","getFactoryForModule","scriptSrc","file","moduleCode","response","fetch","ok","status","statusText","code","text","fetchModuleCode","evaluate","globalThis","Object","keys","loadModule","done","normalized","replace","startsWith","getModuleLayer","dataset","sandboxedDocument","MAX_NODES","nodeCount","warningSent","Proxy","target","prop","bind","tagName","Math","round","call","createTextNode","createDocumentFragment","createComment","createSandboxedDocument","sandboxedWindow","eventListeners","includes","Event","eventName","isInstanceEvent","isSafeGlobal","listeners","findIndex","l","splice","__moduleReady","createSandboxedWindow","tunnel","compartmentGlobals","JSON","Number","Boolean","RegExp","TypeError","RangeError","SyntaxError","parseInt","parseFloat","isNaN","isFinite","cancelAnimationFrame","harden","eval","undefined","Function","setInterval","XMLHttpRequest","MutationObserver","IntersectionObserver","ResizeObserver","buildCompartmentGlobals","globalOverrides","Compartment","createSecureCompartment","__options","err","classes","elementContainsFontAwesome","autoRender","openNode","clearActiveInstance","res","loadPage","md","inner","pre","textContent","loadDocument","iconsLoaded","renderBreadcrumb","segments","split","segment","isLast","join","part","navigateToFolder","sep","folderNode","renderSidebar","sidebarModule","ensureIconsLoaded","items","parentPath","upItem","btn","padStart","label","title","calculateFolderWidth","labelTexts","tempContainer","position","left","top","visibility","body","maxLabelWidth","fontSize","lineHeight","whiteSpace","display","removeChild","totalNeeded","navIndexWidth","ceil","measureLabelsWidth","filter","preloadFolderModules","folderPath","cachedWidth","modulesToPreload","preloadNext","mod","requestIdleCallback","fetchPromise","displayName","infoMatch","match","factoryMatch","trim","extractDisplayNameFromCode","finally","getInitialFolder","tree","buildSearchIndex","pathArray","currentPath","displayPath","searchText","toLowerCase","tags","newPath","rebuildSearchIndex","searchItems","query","trimmedQuery","results","item","score","lowerQuery","lowerText","words","word","scoreMatch","sort","a","aName","bName","localeCompare","handleResultSelection","navItem","updateSelectedResult","direction","scrollIntoView","block","searchDebounceTimer","clearTimeout","highlightedName","indexOf","substring","highlightMatch","el","renderSearchResults","resultsVisible","blur","preventDefault","focus","navigation","nav","initSafeAreaDetector","waitForLayout","frames","count","tick","detectNotchPosition","removeAttribute","angle","screen","orientation","root","setProperty","computedStyle","getComputedStyle","leftValue","getPropertyValue","rightValue","leftPx","rightPx","removeProperty","measureSafeAreas","resizeAbortController","abort","AbortController","signal","race","_","aborted","isPWA","navigator","standalone","hideProgress","overlay","opacity","transition","registerServiceWorker","isSecureContext","location","protocol","isFirstInstall","serviceWorker","getRegistrations","progressOverlay","cssText","showCacheProgress","progress","current","total","progressBar","progressText","progressDetail","fileName","pop","shortName","updateProgress","failedAssets","registration","scope","storage","persist","estimate","newWorker","installing","controller","isMobile","userAgent","isAlreadyPWA","loadManifestConditionally","registered","MathJaxUtility","MathJaxUtil","ctrlKey","metaKey","json","initialFolder","initPreloader","preloader","initSearchEventListeners","search","defaultNode","find","c","defaultBtn"],"mappings":"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"}