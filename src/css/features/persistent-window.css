/* ── Persistent Window Architecture ──────────────────────────────────────────
 *
 * Layout for the synthetic-scrollbar editor container used by the Persistent
 * Window Architecture. All blocks outside the visible range live only in the
 * Rust backend; only ~200 blocks are mounted in TipTap at any time.
 *
 * Class hierarchy:
 *   .persistent-window              — outer scroll container (overflow-y: auto)
 *   .persistent-window__total-space — invisible spacer that forces full scroll height
 *   .persistent-window__editor-anchor — absolutely positioned wrapper for TipTap
 *
 * Modifier classes (added dynamically by PersistentWindow):
 *   .persistent-window__editor-anchor.pw-flyover   — outside loaded range, editor hidden
 *   .persistent-window__editor-anchor.pw-settle    — fade-in after scroll stops / within range
 *
 * Scroll mode tuning tokens (--pw-*):
 *   Override these on .persistent-window to tune scroll UX without touching JS.
 *   Hysteresis and buffer constants are in ViewportCoordinator.ts.
 * ─────────────────────────────────────────────────────────────────────────── */

/* ── Scroll container ─────────────────────────────────────────────────────── */

.persistent-window {
  position: relative;
  overflow-y: auto;
  overflow-x: hidden;

  /* Fill the remaining vertical space inside editor-container */
  flex: 1;
  min-height: 0;

  /* Smooth momentum scrolling on touch devices */
  -webkit-overflow-scrolling: touch;

  /* Disable the browser's scroll anchoring algorithm. Our ViewportCoordinator
   * manages scroll position explicitly via synchronous scrollTop corrections
   * (v5.4). The browser's algorithm selects anchor nodes from the ProseMirror
   * DOM and adjusts scrollTop when those nodes are destroyed by setContent()
   * — fighting our own corrections and causing unpredictable jumps. */
  overflow-anchor: none;

  /* Isolate layout calculations from the rest of the document.
   * This is critical for macOS Safari/Chrome, as it prevents the browser's
   * scroll compositor from recalculating the whole DOM height or triggering
   * synthetic reflow scrolls when we surgically mutate internal absolute nodes. */
  contain: layout paint;

  /* ── Scroll mode tuning tokens ────────────────────────────────────────── */
  /* Adjust these to tune scroll UX feel without touching JS or rebuilding.  */
  /* Note: skeleton mode has been removed. Only flyover (full dim) is used.  */
  --pw-flyover-opacity: 0;      /* Editor opacity while outside loaded range  */
  --pw-fade-out-duration: 120ms; /* Speed of hide transition on flyover        */
  --pw-fade-out-easing: ease-out;
  --pw-fade-in-duration: 40ms;   /* Speed of reveal after settle               */
  --pw-fade-in-easing: ease-out;
}

/* ── Height spacer ────────────────────────────────────────────────────────── */

.persistent-window__total-space {
  /* Height is set dynamically via inline style (= totalEstimatedHeight px).
   * Relative positioning is the offset parent for the editor anchor below. */
  position: relative;
  width: 100%;

  /* Prevent this element from capturing mouse events */
  pointer-events: none;
}

/* ── Editor anchor ────────────────────────────────────────────────────────── */

.persistent-window__editor-anchor {
  position: absolute;
  /* `top` is managed imperatively by PersistentWindow via editorAnchorRef
   * (v5.4) — NOT through React state. This allows the position change,
   * content swap, and scrollTop correction to be batched synchronously.
   * The default 0 is overwritten on first content load. */
  top: 0;
  left: 0;
  right: 0;

  /* Restore pointer events so TipTap receives clicks */
  pointer-events: auto;

  /* Force hardware acceleration and composite isolation on the moving anchor. 
   * This ensures the instantaneous top/translateY swap during surgical updates
   * happens on the GPU, completely detached from Mac's native scroll engine 
   * which otherwise misinterprets the offset shift as a semantic layout jump. */
  transform: translateZ(0);
  will-change: transform, top;

  /* Default fade-out transition (dim/hide during scroll) */
  transition: opacity var(--pw-fade-out-duration) var(--pw-fade-out-easing);
}

/* ── Scroll mode modifiers ────────────────────────────────────────────────── */

/* Outside loaded range: hide editor entirely while new content is fetched */
.persistent-window__editor-anchor.pw-flyover {
  opacity: var(--pw-flyover-opacity);
  pointer-events: none;
}

/* Scroll stopped: fade back in using the settle transition */
.persistent-window__editor-anchor.pw-settle {
  opacity: 1;
  transition: opacity var(--pw-fade-in-duration) var(--pw-fade-in-easing);
}